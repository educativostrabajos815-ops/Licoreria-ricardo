<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS Licorería - Sistema Completo</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js" onload="if(window.lucide) window.lucide.createIcons();"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yape: '#742284',
                        bcp: '#ff7a00',
                        tarjeta: '#2563eb'
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .calendar-day.has-sales { position: relative; }
        .calendar-day.has-sales::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #10b981; }
        .calendar-day.has-gastos::before { content: ''; position: absolute; bottom: 6px; left: calc(50% + 8px); transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #ef4444; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); border-color: #ef4444; } 75% { transform: translateX(4px); border-color: #ef4444; } }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden flex flex-col md:flex-row font-sans selection:bg-indigo-500 selection:text-white">

    <!-- MENÚ -->
    <nav class="w-full md:w-20 bg-slate-950 flex flex-row md:flex-col items-center py-2 md:py-6 border-t md:border-t-0 md:border-r border-slate-800 z-50 fixed bottom-0 md:relative flex-shrink-0 h-16 md:h-full justify-around md:justify-start pb-safe">
        <div class="hidden md:flex w-12 h-12 bg-indigo-600 rounded-xl items-center justify-center mb-8 shadow-lg shadow-indigo-500/30">
            <i data-lucide="wine" class="text-white w-7 h-7"></i>
        </div>
        
        <div class="flex flex-row md:flex-col gap-1 md:gap-4 w-full h-full md:h-auto items-center justify-around">
            <button onclick="switchView('ventas')" id="nav-ventas" class="nav-btn active flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-indigo-400 border-t-2 md:border-t-0 md:border-r-4 border-indigo-500 w-full transition-colors">
                <i data-lucide="shopping-cart" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Ventas</span>
            </button>
            <button onclick="switchView('almacen')" id="nav-almacen" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="package" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Almacén</span>
            </button>
            <button onclick="switchView('soat')" id="nav-soat" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="shield-check" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">SOAT</span>
            </button>
            <button onclick="switchView('agente')" id="nav-agente" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="landmark" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Agente</span>
            </button>
            <button onclick="switchView('caja')" id="nav-caja" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="inbox" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Caja</span>
            </button>
            <button onclick="switchView('analisis')" id="nav-analisis" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="bar-chart-2" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Análisis</span>
            </button>
            <!-- NUEVO BOTÓN: RESPALDO -->
            <button onclick="switchView('respaldo')" id="nav-respaldo" class="nav-btn flex flex-col items-center justify-center gap-1 p-2 md:py-2 text-slate-500 hover:text-slate-300 border-t-2 md:border-t-0 md:border-r-4 border-transparent w-full transition-colors">
                <i data-lucide="database" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span class="text-[9px] md:text-[10px] font-medium hidden sm:block md:block">Respaldo</span>
            </button>
        </div>
    </nav>

    <!-- ÁREA PRINCIPAL CONTENEDOR -->
    <main class="flex-1 flex flex-col overflow-hidden relative mb-16 md:mb-0">

        <!-- VISTA 1: VENTAS (POS) -->
        <div id="view-ventas" class="view-section flex-1 flex flex-col lg:flex-row h-full overflow-y-auto md:overflow-hidden">
            <section class="flex-1 flex flex-col h-fit md:h-full relative border-b md:border-b-0 border-slate-800">
                <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 z-10 flex-shrink-0">
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white" id="ventasHeaderTitle">Nueva Venta</h1>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <select id="posCategoryFilter" onchange="renderPosProducts()" class="w-full sm:w-40 bg-slate-800 text-sm md:text-base text-white border border-slate-700 rounded-lg px-3 py-2.5 md:py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <option value="">Categorías (Todas)</option>
                        </select>
                        <div class="relative w-full sm:w-64">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4 md:w-5 md:h-5"></i>
                            <input type="text" id="searchInput" oninput="renderPosProducts()" placeholder="Buscar producto..." 
                                   class="w-full bg-slate-800 text-sm md:text-base text-white placeholder-slate-400 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 md:py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto no-scrollbar p-4 md:p-6 bg-slate-900/50 min-h-[40vh] md:min-h-0 relative">
                    <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-20">
                        <!-- Productos inyectados por JS -->
                    </div>
                </div>
            </section>

            <!-- TICKET ACTUAL -->
            <aside class="w-full lg:w-[420px] bg-slate-800 border-l border-slate-700 flex flex-col h-[65vh] md:h-full shadow-2xl z-20 flex-shrink-0">
                <header class="p-4 md:p-6 border-b border-slate-700 bg-slate-800 flex-shrink-0">
                    <h2 class="text-base md:text-lg font-bold flex items-center gap-2">
                        <i data-lucide="receipt" class="w-4 h-4 md:w-5 md:h-5 text-indigo-400"></i>
                        Ticket Actual
                    </h2>
                    <div class="text-xs md:text-sm text-slate-400 mt-1" id="ticketDate"></div>
                </header>

                <div class="flex-1 overflow-y-auto no-scrollbar p-3 md:p-4 bg-slate-800/50 relative">
                    <div id="emptyCart" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 space-y-4">
                        <i data-lucide="shopping-bag" class="w-12 h-12 md:w-16 md:h-16 text-slate-600"></i>
                        <p class="text-sm md:text-base">El ticket está vacío</p>
                    </div>
                    <div id="cartItems" class="space-y-2 md:space-y-3 relative z-10 hidden">
                        <!-- Items del carrito -->
                    </div>
                </div>

                <footer class="bg-slate-900 p-4 md:p-5 border-t border-slate-700 flex-shrink-0">
                    <div class="space-y-1 mb-4 border-b border-slate-700/50 pb-3">
                        <div class="flex justify-between text-slate-400 text-xs md:text-sm">
                            <span>Subtotal</span>
                            <span id="subtotalAmount">S/ 0.00</span>
                        </div>
                        <div class="flex justify-between text-slate-400 text-[10px] md:text-xs hidden" id="tarjetaFeeRow">
                            <span>Recargo Tarjeta (<span id="tarjetaFeePercent">0</span>%)</span>
                            <span id="tarjetaFeeAmount">S/ 0.00</span>
                        </div>
                        <div class="flex justify-between text-white text-lg md:text-xl font-bold pt-1">
                            <span>Total</span>
                            <span id="totalAmount">S/ 0.00</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="grid grid-cols-3 gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="payment" value="efectivo" class="peer sr-only" checked onchange="updateCartUI()">
                                <div class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-300 peer-checked:border-emerald-500 peer-checked:text-emerald-400 peer-checked:bg-emerald-500/10 transition-all hover:bg-slate-700">
                                    <i data-lucide="banknote" class="w-4 h-4"></i>
                                    <span class="font-medium text-[10px] md:text-xs">Efectivo</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="payment" value="yape" class="peer sr-only" onchange="updateCartUI()">
                                <div class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-300 peer-checked:border-yape peer-checked:text-yape peer-checked:bg-yape/10 transition-all hover:bg-slate-700">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                                    <span class="font-medium text-[10px] md:text-xs">Yape/Plin</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="payment" value="tarjeta" class="peer sr-only" onchange="updateCartUI()">
                                <div class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-300 peer-checked:border-tarjeta peer-checked:text-tarjeta peer-checked:bg-tarjeta/10 transition-all hover:bg-slate-700">
                                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                                    <span class="font-medium text-[10px] md:text-xs">Tarjeta</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="cancelEditBtn" onclick="cancelEditPos()" class="hidden px-4 py-3 md:py-4 rounded-xl font-bold text-white bg-slate-700 hover:bg-slate-600 transition-all shadow-lg" title="Cancelar Edición">
                            <i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i>
                        </button>
                        <button id="checkoutBtn" class="flex-1 py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg text-white bg-indigo-600 hover:bg-indigo-500 opacity-50 cursor-not-allowed transition-all flex items-center justify-center gap-2 shadow-lg shadow-indigo-600/20" disabled>
                            <i data-lucide="check-circle-2" class="w-5 h-5 md:w-6 md:h-6"></i>
                            Cobrar Venta
                        </button>
                    </div>
                </footer>
            </aside>
        </div>

        <!-- VISTA 2: ALMACÉN E INVENTARIO -->
        <div id="view-almacen" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Inventario y Almacén</h1>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <select id="almacenCategoryFilter" onchange="renderAlmacen()" class="w-full sm:w-40 bg-slate-800 text-sm text-white border border-slate-700 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <option value="">Categorías (Todas)</option>
                    </select>
                    <div class="relative w-full sm:w-64">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="almacenSearchInput" oninput="renderAlmacen()" placeholder="Buscar en almacén..." 
                               class="w-full bg-slate-800 text-sm text-white placeholder-slate-400 border border-slate-700 rounded-lg pl-9 pr-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>
                    <button onclick="openAddProductModal()" class="w-full sm:w-auto px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors shadow-lg shadow-indigo-500/20">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Añadir Producto
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 p-4 md:p-6 flex-shrink-0">
                <div class="bg-slate-800 p-4 md:p-5 rounded-xl border border-slate-700 flex items-center gap-4">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-indigo-500/20 text-indigo-400 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="boxes" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs md:text-sm font-medium">Total Productos</p>
                        <p class="text-xl md:text-2xl font-bold text-white" id="stat-total-products">0</p>
                    </div>
                </div>
                
                <div id="lowStockCard" onclick="filterLowStock()" class="bg-slate-800 hover:bg-slate-700 p-4 md:p-5 rounded-xl border border-slate-700 flex items-center gap-4 cursor-pointer transition-colors group">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center group-hover:bg-red-500/30 transition-colors flex-shrink-0">
                        <i data-lucide="alert-triangle" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-slate-400 text-xs md:text-sm font-medium">Poco Stock</p>
                        <p class="text-xl md:text-2xl font-bold text-white" id="stat-low-stock">0</p>
                    </div>
                    <i id="lowStockIcon" data-lucide="filter" class="w-4 h-4 md:w-5 md:h-5 text-slate-500 group-hover:text-red-400 transition-colors"></i>
                </div>
            </div>

            <div class="flex-1 p-4 md:p-6 pt-0 overflow-hidden flex flex-col">
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-x-auto flex-1 h-full">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-slate-900/50 text-slate-400 text-xs md:text-sm uppercase tracking-wider border-b border-slate-700">
                                <th class="p-3 md:p-4 font-medium">Producto</th>
                                <th class="p-3 md:p-4 font-medium">Categoría</th>
                                <th class="p-3 md:p-4 font-medium text-right">Precio Ref.</th>
                                <th class="p-3 md:p-4 font-medium text-center">Stock Físico</th>
                                <th class="p-3 md:p-4 font-medium">Estado</th>
                                <th class="p-3 md:p-4 font-medium text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="almacenTableBody" class="divide-y divide-slate-700/50">
                            <!-- Filas de Almacen -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VISTA 3: SOAT -->
        <div id="view-soat" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Venta de SOAT</h1>
                </div>
                <button onclick="openConfigModal()" class="p-2 md:p-2.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 hover:text-white rounded-lg transition-colors shadow-lg flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4 md:w-5 md:h-5"></i>
                    <span class="text-sm font-medium hidden md:inline">Ajustes Generales</span>
                </button>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-6 flex flex-col lg:flex-row gap-4 md:gap-6">
                <div class="w-full lg:w-1/3 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 h-fit shadow-lg">
                    <h2 class="text-base md:text-lg font-bold text-white mb-4 flex items-center gap-2" id="soatHeaderTitle">
                        <i data-lucide="file-text" class="w-5 h-5 text-indigo-400"></i> Nuevo SOAT
                    </h2>
                    <form id="soatForm" class="space-y-3 md:space-y-4">
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">N° de Placa</label>
                            <input type="text" id="soat_placa" required placeholder="Ej: ABC-123" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-indigo-500 uppercase">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Tipo de Vehículo</label>
                            <select id="soat_tipo" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-indigo-500 appearance-none">
                                <option value="Auto">Automóvil / Sedán</option>
                                <option value="Moto">Motocicleta lineal</option>
                                <option value="Camioneta">Camioneta / SUV</option>
                                <option value="Taxi">Taxi / Colectivo</option>
                                <option value="Mototaxi">Mototaxi</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">DNI / RUC</label>
                            <input type="number" id="soat_dni" required placeholder="Documento" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Descripción</label>
                            <input type="text" id="soat_desc" placeholder="Opcional..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Total Cobrado (S/)</label>
                            <input type="number" id="soat_precio" required min="0" step="0.10" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div class="pt-1 md:pt-2">
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1 md:mb-2">Método de pago</label>
                            <div class="grid grid-cols-2 gap-2 md:gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="soatPayment" value="efectivo" class="peer sr-only" checked>
                                    <div class="text-center p-2 rounded-lg border border-slate-600 peer-checked:bg-emerald-500/20 peer-checked:text-emerald-400 peer-checked:border-emerald-500 transition-all text-xs md:text-sm">Efectivo</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="soatPayment" value="yape" class="peer sr-only">
                                    <div class="text-center p-2 rounded-lg border border-slate-600 peer-checked:bg-yape/20 peer-checked:text-yape peer-checked:border-yape transition-all text-xs md:text-sm">Yape/Plin</div>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button type="button" id="cancelSoatEditBtn" onclick="cancelEditSoat()" class="hidden px-3 md:px-4 py-2.5 md:py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-colors">
                                <i data-lucide="x" class="w-4 h-4 md:w-5 md:h-5"></i>
                            </button>
                            <button type="button" onclick="registerSoat()" class="flex-1 py-2.5 md:py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm md:text-base font-bold transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="shield-plus" class="w-4 h-4 md:w-5 md:h-5"></i> <span id="soatBtnText">Registrar SOAT</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex-1 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 shadow-lg flex flex-col">
                    <h2 class="text-base md:text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 md:w-5 md:h-5 text-slate-400"></i> SOATs Vendidos Hoy
                    </h2>
                    <div class="flex-1 overflow-auto no-scrollbar">
                        <div id="soatHistoryList" class="space-y-2 md:space-y-3">
                            <!-- Items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 3.5: AGENTE BANCARIO -->
        <div id="view-agente" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Servicios Agente</h1>
                </div>
                <button onclick="openConfigModal()" class="p-2 md:p-2.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 hover:text-white rounded-lg transition-colors shadow-lg flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4 md:w-5 md:h-5"></i>
                    <span class="text-sm font-medium hidden md:inline">Ajustes Generales</span>
                </button>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-6 flex flex-col lg:flex-row gap-4 md:gap-6">
                <div class="w-full lg:w-1/3 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 h-fit shadow-lg">
                    <h2 class="text-base md:text-lg font-bold text-white mb-4 flex items-center gap-2" id="agenteHeaderTitle">
                        <i data-lucide="landmark" class="w-5 h-5 text-bcp"></i> Nueva Operación
                    </h2>
                    <form id="agenteForm" class="space-y-3 md:space-y-4">
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Entidad Bancaria</label>
                            <select id="agente_banco" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-bcp appearance-none">
                                <option value="BCP">Agente BCP</option>
                                <option value="Interbank">Agente Interbank</option>
                                <option value="BBVA">Agente BBVA</option>
                                <option value="Otro">Otro Agente</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Tipo de Operación</label>
                            <select id="agente_tipo" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-bcp appearance-none">
                                <option value="Depósito">Depósito a Cuenta</option>
                                <option value="Retiro">Retiro de Efectivo</option>
                                <option value="Pago de Servicios">Pago de Servicios / Recibo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Cuenta / DNI</label>
                            <input type="text" id="agente_doc" required placeholder="191-0000..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-bcp">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Monto de Operación (S/)</label>
                            <input type="number" id="agente_monto" required min="0" step="0.10" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 md:px-4 md:py-2.5 text-white focus:outline-none focus:border-bcp">
                        </div>
                        <div class="pt-1 md:pt-2">
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1 md:mb-2">Dinero de tienda Vía:</label>
                            <div class="grid grid-cols-2 gap-2 md:gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="agentePayment" value="efectivo" class="peer sr-only" checked>
                                    <div class="text-center p-2 rounded-lg border border-slate-600 peer-checked:bg-emerald-500/20 peer-checked:text-emerald-400 peer-checked:border-emerald-500 transition-all text-xs md:text-sm">Efectivo</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="agentePayment" value="yape" class="peer sr-only">
                                    <div class="text-center p-2 rounded-lg border border-slate-600 peer-checked:bg-yape/20 peer-checked:text-yape peer-checked:border-yape transition-all text-xs md:text-sm">Yape/Plin</div>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button type="button" id="cancelAgenteEditBtn" onclick="cancelEditAgente()" class="hidden px-3 md:px-4 py-2.5 md:py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-colors">
                                <i data-lucide="x" class="w-4 h-4 md:w-5 md:h-5"></i>
                            </button>
                            <button type="button" onclick="registerAgente()" class="flex-1 py-2.5 md:py-3 bg-bcp hover:bg-orange-600 text-white rounded-xl text-sm md:text-base font-bold transition-colors flex justify-center items-center gap-2 shadow-lg shadow-orange-600/20">
                                <i data-lucide="check-circle" class="w-4 h-4 md:w-5 md:h-5"></i> <span id="agenteBtnText">Registrar Operación</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex-1 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 shadow-lg flex flex-col">
                    <h2 class="text-base md:text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 md:w-5 md:h-5 text-slate-400"></i> Operaciones de Hoy
                    </h2>
                    <div class="flex-1 overflow-auto no-scrollbar">
                        <div id="agenteHistoryList" class="space-y-2 md:space-y-3">
                            <!-- Items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 4: CAJA (RESUMEN DEL DÍA) -->
        <div id="view-caja" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Caja del Día</h1>
                </div>
                <button onclick="cerrarCaja()" class="px-4 py-2 md:px-5 md:py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm md:text-base font-bold flex items-center gap-2 transition-colors shadow-lg">
                    <i data-lucide="lock" class="w-4 h-4 md:w-5 md:h-5"></i> Cerrar
                </button>
            </header>
            
            <div class="p-4 md:p-6 grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 overflow-y-auto md:overflow-visible">
                <div class="bg-slate-800 p-3 md:p-4 rounded-xl border border-slate-700 cursor-pointer hover:border-emerald-500 transition-colors group" onclick="showBreakdown('POS')" title="Ver Desglose">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-slate-400 font-medium text-xs md:text-sm">Ingreso POS</p>
                        <i data-lucide="pie-chart" class="w-3 h-3 md:w-4 md:h-4 text-slate-600 group-hover:text-emerald-400"></i>
                    </div>
                    <p class="text-lg md:text-xl font-bold text-emerald-400" id="caja-ingresos-pos">S/ 0.00</p>
                </div>
                <div class="bg-slate-800 p-3 md:p-4 rounded-xl border border-slate-700">
                    <p class="text-slate-400 font-medium mb-1 text-xs md:text-sm">Comisión SOAT</p>
                    <p class="text-lg md:text-xl font-bold text-indigo-400" id="caja-ingresos-soat">S/ 0.00</p>
                </div>
                <div class="bg-slate-800 p-3 md:p-4 rounded-xl border border-slate-700">
                    <p class="text-slate-400 font-medium mb-1 text-xs md:text-sm">Comisión Agente</p>
                    <p class="text-lg md:text-xl font-bold text-bcp" id="caja-ingresos-agente">S/ 0.00</p>
                </div>
                <div class="bg-slate-800 p-3 md:p-4 rounded-xl border border-slate-700">
                    <p class="text-slate-400 font-medium mb-1 text-xs md:text-sm">Gastos (Tienda)</p>
                    <p class="text-lg md:text-xl font-bold text-red-400" id="caja-gastos-totales">S/ 0.00</p>
                </div>
                <div class="bg-slate-800 p-3 md:p-4 rounded-xl relative overflow-hidden col-span-2 lg:col-span-1 shadow-lg border border-indigo-500/30 cursor-pointer hover:border-indigo-400 transition-colors group" onclick="showBreakdown('NETA')" title="Ver Desglose">
                    <div class="flex justify-between items-center mb-1 z-10 relative">
                        <p class="text-slate-300 font-medium text-xs md:text-sm">CAJA NETA</p>
                        <i data-lucide="pie-chart" class="w-3 h-3 md:w-4 md:h-4 text-indigo-400 group-hover:text-white"></i>
                    </div>
                    <p class="text-xl md:text-2xl font-bold text-white z-10 relative" id="caja-total">S/ 0.00</p>
                    <div class="absolute right-0 bottom-0 opacity-10">
                        <i data-lucide="wallet" class="w-12 h-12 md:w-16 md:h-16 -mr-2 -mb-2"></i>
                    </div>
                </div>
            </div>

            <div class="px-4 md:px-6 flex-1 flex flex-col gap-4 overflow-hidden pb-4 md:pb-6">
                 <div class="w-full lg:w-1/2 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 flex flex-col flex-1 min-h-[300px]">
                    <h3 class="text-base md:text-lg font-bold text-white mb-3 md:mb-4" id="gastoHeaderTitle">Registrar Gasto</h3>
                    <div class="flex flex-col gap-2 md:gap-3">
                        <div class="flex gap-2 md:gap-3">
                            <input type="text" id="gastoDesc" placeholder="Ej: Hielo..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm md:text-base text-white focus:outline-none focus:border-indigo-500 transition-colors">
                            <input type="number" id="gastoMonto" placeholder="S/ 0.00" class="w-24 md:w-32 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm md:text-base text-white focus:outline-none focus:border-indigo-500 transition-colors">
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <div class="flex gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="gastoPayment" value="efectivo" class="peer sr-only" checked>
                                    <div class="text-center px-2 py-1 md:px-3 md:py-1.5 rounded-lg border border-slate-600 peer-checked:bg-emerald-500/20 peer-checked:text-emerald-400 peer-checked:border-emerald-500 transition-all text-[10px] md:text-xs font-medium">Efectivo</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="gastoPayment" value="yape" class="peer sr-only">
                                    <div class="text-center px-2 py-1 md:px-3 md:py-1.5 rounded-lg border border-slate-600 peer-checked:bg-yape/20 peer-checked:text-yape peer-checked:border-yape transition-all text-[10px] md:text-xs font-medium">Yape/Plin</div>
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" id="cancelGastoEditBtn" onclick="cancelEditGasto()" class="hidden px-2 py-1 md:px-3 md:py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold transition-colors">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                                <button id="btnGasto" onclick="registrarGasto()" class="px-4 py-1.5 md:px-6 md:py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm md:text-base rounded-lg transition-colors font-medium">Añadir</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar mt-4">
                        <div id="listaGastos" class="space-y-2">
                            <!-- Lista de gastos -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 5: ANÁLISIS (CALENDARIO) -->
        <div id="view-analisis" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Análisis</h1>
                </div>
                <div class="text-right">
                    <p class="text-xs md:text-sm text-slate-400">Total Mes Neto</p>
                    <p class="text-lg md:text-2xl font-bold text-emerald-400" id="analisis-total-mes">S/ 0.00</p>
                </div>
            </header>

            <div class="flex-1 p-4 md:p-6 flex flex-col lg:flex-row gap-4 md:gap-6 overflow-y-auto">
                <div class="w-full lg:w-2/3 bg-slate-800 rounded-xl border border-slate-700 p-4 md:p-6 flex flex-col min-h-[400px] lg:min-h-[500px] shadow-lg">
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <h2 class="text-lg md:text-xl font-bold text-white" id="calendarMonthLabel">Mes Año</h2>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="p-1.5 md:p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"><i data-lucide="chevron-left" class="w-4 h-4 md:w-5 md:h-5 text-white"></i></button>
                            <button onclick="changeMonth(1)" class="p-1.5 md:p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"><i data-lucide="chevron-right" class="w-4 h-4 md:w-5 md:h-5 text-white"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Dom</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Lun</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Mar</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Mié</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Jue</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Vie</div>
                        <div class="text-center text-[10px] md:text-sm font-medium text-slate-500 py-1 md:py-2">Sáb</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 md:gap-2 flex-1">
                        <!-- Días -->
                    </div>
                </div>

                <div class="w-full lg:w-1/3 bg-slate-800 rounded-xl border border-slate-700 flex flex-col min-h-[350px] shadow-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-slate-700 bg-slate-800/80">
                        <h3 class="text-base md:text-lg font-bold text-white mb-1">Detalle del Día</h3>
                        <p class="text-xs md:text-sm text-slate-400" id="selectedDateLabel">Selecciona un día</p>
                        
                        <div class="mt-3 md:mt-4 grid grid-cols-2 gap-2 md:gap-3">
                            <div class="bg-slate-900 rounded-lg p-2 md:p-3 border border-slate-700 text-center cursor-pointer hover:border-emerald-500 transition-colors group" onclick="showBreakdown('POS', window.currentSelectedDayObj)" title="Ver Desglose">
                                <div class="flex justify-center items-center gap-1 mb-1">
                                    <p class="text-[10px] md:text-xs text-slate-400">Ingreso POS</p>
                                    <i data-lucide="pie-chart" class="w-3 h-3 text-slate-600 group-hover:text-emerald-400"></i>
                                </div>
                                <p class="text-base md:text-lg font-bold text-emerald-400" id="selectedDayIngresos">S/ 0.00</p>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-2 md:p-3 border border-slate-700 text-center">
                                <p class="text-[10px] md:text-xs text-slate-400 mb-1">Gastos</p>
                                <p class="text-base md:text-lg font-bold text-red-400" id="selectedDayGastos">S/ 0.00</p>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-2 md:p-3 border border-slate-700 text-center cursor-pointer hover:border-white transition-colors group" onclick="showBreakdown('NETA', window.currentSelectedDayObj)" title="Ver Desglose">
                                <div class="flex justify-center items-center gap-1 mb-1">
                                    <p class="text-[10px] md:text-xs text-slate-400">Caja Neta</p>
                                    <i data-lucide="pie-chart" class="w-3 h-3 text-slate-600 group-hover:text-white"></i>
                                </div>
                                <p class="text-base md:text-lg font-bold text-white" id="selectedDayNeto">S/ 0.00</p>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-2 md:p-3 border border-slate-700 text-center">
                                <p class="text-[10px] md:text-xs text-slate-400 mb-1">Transac.</p>
                                <p class="text-base md:text-lg font-bold text-slate-300" id="selectedDayCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-auto p-3 md:p-4 space-y-2 md:space-y-3 no-scrollbar" id="selectedDayTransactions">
                        <div class="h-full flex items-center justify-center text-slate-500 text-xs md:text-sm text-center">
                            Haz clic en un día.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 6: RESPALDO Y RESTAURACIÓN -->
        <div id="view-respaldo" class="view-section flex-1 flex flex-col h-full hidden bg-slate-900 relative">
            <header class="p-4 md:p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Respaldo de Datos</h1>
                    <p class="text-xs md:text-sm text-slate-400 mt-1">Exporta o restaura la información de tu sistema mediante archivos JSON.</p>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-6 flex flex-col lg:flex-row gap-4 md:gap-6">
                <!-- Tarjeta Exportar -->
                <div class="w-full lg:w-1/2 bg-slate-800 rounded-xl border border-slate-700 p-5 md:p-6 shadow-lg h-fit">
                    <div class="w-12 h-12 bg-indigo-500/20 text-indigo-400 rounded-xl flex items-center justify-center mb-4">
                        <i data-lucide="download-cloud" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-lg font-bold text-white mb-2">Generar Respaldo</h2>
                    <p class="text-xs md:text-sm text-slate-400 mb-5">Selecciona qué información deseas guardar en tu dispositivo.</p>
                    
                    <div class="space-y-3 mb-6">
                        <label class="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="chkExpInv" class="w-5 h-5 rounded bg-slate-800 border-slate-600 text-indigo-500 focus:ring-indigo-500" checked>
                            <span class="text-sm font-medium text-slate-200">Inventario y Productos (Almacén)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="chkExpHist" class="w-5 h-5 rounded bg-slate-800 border-slate-600 text-indigo-500 focus:ring-indigo-500" checked>
                            <span class="text-sm font-medium text-slate-200">Historial de Ventas y Gastos (Análisis)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="chkExpConf" class="w-5 h-5 rounded bg-slate-800 border-slate-600 text-indigo-500 focus:ring-indigo-500" checked>
                            <span class="text-sm font-medium text-slate-200">Configuraciones (Recargos y Comisiones)</span>
                        </label>
                    </div>

                    <button onclick="exportBackup()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-colors flex justify-center items-center gap-2 shadow-lg shadow-indigo-500/20">
                        <i data-lucide="save" class="w-5 h-5"></i> Descargar Archivo (.json)
                    </button>
                </div>

                <!-- Tarjeta Importar -->
                <div class="w-full lg:w-1/2 bg-slate-800 rounded-xl border border-slate-700 p-5 md:p-6 shadow-lg h-fit">
                    <div class="w-12 h-12 bg-emerald-500/20 text-emerald-400 rounded-xl flex items-center justify-center mb-4">
                        <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-lg font-bold text-white mb-2">Restaurar Sistema</h2>
                    <p class="text-xs md:text-sm text-slate-400 mb-5">Sube un archivo de respaldo previo para restaurar la información. <strong class="text-red-400">Atención: Esto reemplazará los datos actuales.</strong></p>
                    
                    <div class="border-2 border-dashed border-slate-600 rounded-xl p-8 flex flex-col items-center justify-center text-center bg-slate-900/50 mb-6">
                        <i data-lucide="file-json" class="w-10 h-10 text-slate-500 mb-3"></i>
                        <p class="text-sm text-slate-300 mb-1">Selecciona tu archivo de respaldo</p>
                        <p class="text-[10px] md:text-xs text-slate-500">Solo formato .json</p>
                    </div>

                    <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportBackup(event)">
                    <button onclick="triggerImport()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition-colors flex justify-center items-center gap-2 shadow-lg shadow-emerald-500/20">
                        <i data-lucide="folder-open" class="w-5 h-5"></i> Seleccionar Archivo
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- MODALES DE LA APLICACIÓN -->

    <!-- Modal: Desglose de Pagos -->
    <div id="breakdownModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-slate-800 rounded-2xl p-5 md:p-6 max-w-sm w-full transform scale-95 transition-transform duration-300 flex flex-col border border-slate-700 shadow-2xl">
            <header class="flex justify-between items-center mb-5 md:mb-6">
                <div>
                    <h3 class="text-base md:text-lg font-bold text-white flex items-center gap-2" id="brkTitle">Desglose</h3>
                    <p class="text-[10px] md:text-xs text-slate-400 mt-1" id="brkDate"></p>
                </div>
                <button onclick="closeBreakdownModal()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </header>
            
            <div class="space-y-3 mb-5 md:mb-6">
                <div class="flex justify-between items-center p-3 md:p-4 bg-slate-900 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2 text-emerald-400">
                        <i data-lucide="banknote" class="w-4 h-4 md:w-5 md:h-5"></i>
                        <span class="font-medium text-sm md:text-base">Efectivo</span>
                    </div>
                    <span class="font-bold text-white text-base md:text-lg" id="brkEfectivo">S/ 0.00</span>
                </div>
                <div class="flex justify-between items-center p-3 md:p-4 bg-slate-900 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2 text-yape">
                        <svg class="w-4 h-4 md:w-5 md:h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <span class="font-medium text-sm md:text-base">Yape / Plin</span>
                    </div>
                    <span class="font-bold text-white text-base md:text-lg" id="brkYape">S/ 0.00</span>
                </div>
                <div class="flex justify-between items-center p-3 md:p-4 bg-slate-900 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2 text-tarjeta">
                        <i data-lucide="credit-card" class="w-4 h-4 md:w-5 md:h-5"></i>
                        <span class="font-medium text-sm md:text-base">Tarjeta</span>
                    </div>
                    <span class="font-bold text-white text-base md:text-lg" id="brkTarjeta">S/ 0.00</span>
                </div>
            </div>

            <button onclick="closeBreakdownModal()" class="w-full py-2.5 md:py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-sm md:text-base font-medium transition-colors">Cerrar</button>
        </div>
    </div>

    <!-- Modal: Configurar Ganancias/Recargos -->
    <div id="configModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-slate-800 rounded-2xl p-5 md:p-6 max-w-sm w-full transform scale-95 transition-transform duration-300 flex flex-col border border-slate-700 shadow-2xl">
            <header class="flex justify-between items-center mb-5 md:mb-6">
                <h3 class="text-base md:text-lg font-bold text-white flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-slate-400"></i> Ajustes Generales</h3>
                <button onclick="closeConfigModal()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </header>
            <div class="space-y-4 mb-5 md:mb-6">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Ganancia por SOAT (%)</label>
                    <div class="relative">
                        <input type="number" id="cfg_soat" min="0" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">%</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Ganancia por Agente (%)</label>
                    <div class="relative">
                        <input type="number" id="cfg_agente" min="0" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-bcp">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">%</span>
                    </div>
                </div>
                <div class="pt-4 border-t border-slate-700">
                    <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Recargo por Cobro con Tarjeta (%)</label>
                    <div class="relative">
                        <input type="number" id="cfg_tarjeta" min="0" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-tarjeta">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">%</span>
                    </div>
                </div>
            </div>
            <button onclick="saveConfig()" class="w-full py-2.5 md:py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm md:text-base font-medium transition-colors">Guardar Cambios</button>
        </div>
    </div>

    <!-- Modal: Éxito -->
    <div id="successModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4 z-[60]">
        <div class="bg-slate-800 rounded-2xl p-6 md:p-8 max-w-sm w-full transform scale-95 transition-transform duration-300 flex flex-col items-center text-center border border-slate-700 shadow-2xl">
            <div class="w-14 h-14 md:w-16 md:h-16 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center mb-3 md:mb-4">
                <i data-lucide="check" class="w-7 h-7 md:w-8 md:h-8"></i>
            </div>
            <h3 id="successTitle" class="text-lg md:text-xl font-bold text-white mb-2">¡Registrado!</h3>
            <div id="successMessage" class="text-sm md:text-base text-slate-400 mb-5 md:mb-6 w-full">Operación guardada.</div>
            <button onclick="closeSuccessModal()" class="w-full py-2.5 md:py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-sm md:text-base font-medium transition-colors">Continuar</button>
        </div>
    </div>

    <!-- Modal: Producto con Venta Avanzada -->
    <div id="addProductModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4 py-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-lg border border-slate-700 shadow-2xl flex flex-col overflow-hidden max-h-full">
            <header class="p-4 md:p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800 flex-shrink-0">
                <h3 id="modalTitle" class="text-base md:text-lg font-bold text-white flex items-center gap-2"><i data-lucide="package-plus" class="w-5 h-5 text-indigo-400"></i> Producto</h3>
                <button onclick="closeAddProductModal()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </header>
            
            <div class="p-4 md:p-5 overflow-y-auto flex-1 custom-scrollbar">
                <form id="newProductForm" class="space-y-4">
                    <!-- Datos Básicos -->
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Nombre del Producto</label>
                        <input type="text" id="p_name" required placeholder="Ej: Ron Cartavio" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Tamaño / Detalles</label>
                            <input type="text" id="p_size" required placeholder="Ej: 750ml" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Categoría</label>
                            <input type="text" id="p_category" list="category-list" required placeholder="Escriba o seleccione..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                            <datalist id="category-list">
                                <!-- Llenado por JS dinámicamente -->
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Stock Físico</label>
                            <input type="number" id="p_stock" required min="0" placeholder="0" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Aviso Poco Stock</label>
                            <input type="number" id="p_minstock" required min="0" placeholder="5" value="5" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs md:text-sm font-medium text-slate-300 mb-1">Precio Base (S/)</label>
                        <input type="number" id="p_price" required min="0" step="0.10" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                    </div>

                    <!-- Venta Avanzada Accordion -->
                    <div class="mt-4 border border-slate-700 rounded-xl overflow-hidden">
                        <button type="button" onclick="toggleAdvancedSales()" class="w-full bg-slate-800 p-3 flex justify-between items-center text-sm font-bold text-slate-300 hover:text-white transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="settings-2" class="w-4 h-4 text-indigo-400"></i> Venta Avanzada</span>
                            <i data-lucide="chevron-down" id="advArrow" class="w-4 h-4 transition-transform"></i>
                        </button>
                        
                        <div id="advancedSalesSection" class="hidden p-4 bg-slate-900/50 space-y-5 border-t border-slate-700">
                            
                            <!-- 1. Paquetes -->
                            <div>
                                <label class="flex items-center gap-2 cursor-pointer mb-3">
                                    <input type="checkbox" id="p_isGroup" class="w-4 h-4 rounded bg-slate-900 border-slate-700 text-indigo-500 focus:ring-indigo-500" onchange="toggleGroupInputs()">
                                    <h4 class="text-xs font-bold text-indigo-400 uppercase tracking-wider m-0">1. Venta por Paquetes</h4>
                                </label>
                                <div id="groupInputs" class="hidden grid grid-cols-2 gap-3 bg-slate-800 p-3 rounded-lg border border-slate-700">
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Unidades por Paquete</label>
                                        <input type="number" id="p_unitsPerGroup" min="2" placeholder="6" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Precio x Unidad Suelta</label>
                                        <input type="number" id="p_unitPrice" min="0" step="0.10" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:border-indigo-500">
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Descuentos por cantidad -->
                            <div>
                                <h4 class="text-xs font-bold text-indigo-400 mb-2 uppercase tracking-wider">2. Dcto. por Cantidad</h4>
                                <div id="qtyDiscountsList" class="space-y-2 mb-2"></div>
                                <button type="button" onclick="addQtyDiscount()" class="text-xs font-medium text-emerald-400 hover:text-emerald-300 flex items-center gap-1"><i data-lucide="plus-circle" class="w-3 h-3"></i> Añadir regla de descuento</button>
                            </div>

                            <!-- 3. Promociones (Combos) -->
                            <div>
                                <h4 class="text-xs font-bold text-indigo-400 mb-2 uppercase tracking-wider">3. Promociones y Combos</h4>
                                <div id="promosList" class="space-y-3 mb-2"></div>
                                <button type="button" onclick="addPromoRow()" class="text-xs font-medium text-emerald-400 hover:text-emerald-300 flex items-center gap-1"><i data-lucide="plus-circle" class="w-3 h-3"></i> Crear Promoción</button>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
            <footer class="p-4 md:p-5 border-t border-slate-700 bg-slate-800 flex justify-end gap-2 md:gap-3 flex-shrink-0">
                <button onclick="closeAddProductModal()" class="px-4 py-2 md:px-5 md:py-2.5 text-sm md:text-base rounded-lg font-medium text-slate-300 hover:bg-slate-700 transition-colors">Cancelar</button>
                <button type="button" onclick="saveProduct()" class="px-4 py-2 md:px-5 md:py-2.5 text-sm md:text-base rounded-lg font-medium text-white bg-indigo-600 hover:bg-indigo-500 transition-colors">Guardar Producto</button>
            </footer>
        </div>
    </div>

    <!-- Modal: Detalles de Transacción -->
    <div id="txDetailsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300 max-h-[90vh]">
            <header class="p-4 md:p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                <h3 id="txModalTitle" class="text-base md:text-lg font-bold text-white flex items-center gap-2">Detalle</h3>
                <button onclick="closeTxModal()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </header>
            <div class="p-4 md:p-5 overflow-y-auto no-scrollbar flex-1" id="txModalBody">
                <!-- Contenido Inyectado -->
            </div>
            <footer class="p-3 md:p-4 border-t border-slate-700 bg-slate-800 flex gap-2" id="txModalFooter">
                <!-- Botones Inyectados -->
            </footer>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- ESTADO GLOBAL ---
        window.inventory = [];
        window.cart = []; 
        window.currentIdCounter = 1;
        window.salesHistory = []; 
        window.gastosHistory = [];
        
        window.currentSelectedDayObj = new Date();
        window.currentCalDate = new Date();
        window.lastUpdated = 0; 
        
        window.editingPos = null;
        window.editingSoat = null;
        window.editingAgente = null;
        window.editingGasto = null;
        
        window.modalDiscounts = [];
        window.modalPromos = [];

        window.appConfig = { soatMargin: 5, agenteMargin: 1, tarjetaMargin: 5 };
        
        window.db = null; window.auth = null; window.appId = null; window.userId = null;
        window.setDocFb = null; window.docFb = null; window.onSnapshotFb = null;

        function updateIcons() {
            if (window.lucide && window.lucide.createIcons) window.lucide.createIcons();
        }

        function safeDateParse(dateStr) { let d = new Date(dateStr); return isNaN(d) ? new Date() : d; }
        function safeISOString(d) { try { return (d instanceof Date && !isNaN(d)) ? d.toISOString() : new Date(d).toISOString(); } catch(e) { return new Date().toISOString(); } }
        function generateId() { return Math.random().toString(36).substr(2, 9); }

        // --- FIREBASE ---
        async function initFirebase() {
            try {
                const appModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                
                window.setDocFb = firestoreModule.setDoc; window.docFb = firestoreModule.doc; window.onSnapshotFb = firestoreModule.onSnapshot;

                const firebaseConfig = {
                    apiKey: "AIzaSyAazrObshsvPDIucwOXgB3mAASmRGU0T1E",
                    authDomain: "licoreria-ricardo.firebaseapp.com",
                    projectId: "licoreria-ricardo",
                    storageBucket: "licoreria-ricardo.firebasestorage.app",
                    messagingSenderId: "216793010129",
                    appId: "1:216793010129:web:1b40dc210724c86b509af0",
                    measurementId: "G-W9CT9MG34F"
                };
                
                window.appId = 'raspadillas-pos-v2';

                const app = appModule.initializeApp(firebaseConfig);
                window.auth = authModule.getAuth(app);
                window.db = firestoreModule.getFirestore(app);

                const initAuth = async () => { await authModule.signInAnonymously(window.auth); };

                initAuth().then(() => {
                    authModule.onAuthStateChanged(window.auth, (user) => {
                        if (user) { window.userId = user.uid; loadDataFromFirebase(); }
                    });
                });
            } catch (e) { console.log("Iniciando localmente (sin nube)."); }
        }

        function loadDataFromFirebase() {
            if(!window.db || !window.userId || !window.onSnapshotFb) return;
            const docRef = window.docFb(window.db, 'artifacts', window.appId, 'users', window.userId, 'pos_data_v1', 'store_data');
            
            window.onSnapshotFb(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudTime = data.lastUpdated || 0; const localTime = window.lastUpdated || 0;

                    if (cloudTime > localTime) {
                        window.inventory = data.inventory || [];
                        window.currentIdCounter = data.currentIdCounter || 1;
                        window.appConfig = data.appConfig || window.appConfig;
                        window.lastUpdated = cloudTime;
                        window.salesHistory = (data.salesHistory || []).map(s => ({...s, date: safeDateParse(s.date)}));
                        window.gastosHistory = (data.gastosHistory || []).map(g => ({...g, date: safeDateParse(g.date)}));

                        localStorage.setItem('pos_licoreria_data', JSON.stringify(data));
                        updateCategoryFilters();
                        if (window.cart.length > 0) {
                            window.cart.forEach(c => {
                                const updatedProd = window.inventory.find(p => p.id == c.product.id);
                                if (updatedProd) c.product = updatedProd;
                            });
                            updateCartUI();
                        }
                        renderActiveViewOnly();
                    } else if (localTime > cloudTime) { saveDataToCloudOnly(); }
                } else if (window.lastUpdated > 0) { saveDataToCloudOnly(); }
            }, (error) => {});
        }

        function saveDataToCloudOnly() {
            if (!window.db || !window.userId || !window.setDocFb) return;
            try {
                const dataToSave = {
                    inventory: window.inventory, currentIdCounter: window.currentIdCounter, 
                    salesHistory: window.salesHistory.map(s => ({...s, date: safeISOString(s.date)})), 
                    gastosHistory: window.gastosHistory.map(g => ({...g, date: safeISOString(g.date)})), 
                    appConfig: window.appConfig, lastUpdated: window.lastUpdated 
                };
                const docRef = window.docFb(window.db, 'artifacts', window.appId, 'users', window.userId, 'pos_data_v1', 'store_data');
                window.setDocFb(docRef, dataToSave).catch(e=>{});
            } catch (e) {}
        }

        function loadDataLocally() {
            try {
                const localData = localStorage.getItem('pos_licoreria_data');
                if (localData) {
                    const data = JSON.parse(localData);
                    window.inventory = data.inventory || []; window.currentIdCounter = data.currentIdCounter || 1;
                    window.appConfig = { ...window.appConfig, ...(data.appConfig || {}) }; window.lastUpdated = data.lastUpdated || 0; 
                    window.salesHistory = (data.salesHistory || []).map(s => ({...s, date: safeDateParse(s.date)}));
                    window.gastosHistory = (data.gastosHistory || []).map(g => ({...g, date: safeDateParse(g.date)}));
                }
            } catch (e) {}
            updateCategoryFilters();
        }

        function saveData() {
            try {
                window.lastUpdated = Date.now(); 
                const dataToSave = {
                    inventory: window.inventory, currentIdCounter: window.currentIdCounter, 
                    salesHistory: window.salesHistory.map(s => ({...s, date: safeISOString(s.date)})), 
                    gastosHistory: window.gastosHistory.map(g => ({...g, date: safeISOString(g.date)})), 
                    appConfig: window.appConfig, lastUpdated: window.lastUpdated
                };
                localStorage.setItem('pos_licoreria_data', JSON.stringify(dataToSave));
                saveDataToCloudOnly();
                updateCategoryFilters();
            } catch (e) {}
        }

        // --- FILTROS GLOBALES ---
        function updateCategoryFilters() {
            let uniqueCategories = [...new Set(window.inventory.map(p => p.category).filter(Boolean))];
            
            const buildOptions = (cats, selected) => {
                let html = `<option value="">Categorías (Todas)</option>`;
                cats.sort().forEach(c => { html += `<option value="${c}" ${c === selected ? 'selected' : ''}>${c}</option>`; });
                return html;
            };

            const posFilter = document.getElementById('posCategoryFilter');
            const posVal = posFilter.value;
            posFilter.innerHTML = buildOptions(uniqueCategories, posVal);

            const almFilter = document.getElementById('almacenCategoryFilter');
            const almVal = almFilter.value;
            almFilter.innerHTML = buildOptions(uniqueCategories, almVal);
            
            const datalist = document.getElementById('category-list');
            if (uniqueCategories.length === 0) { uniqueCategories = ['Licor', 'Gaseosa', 'Snack', 'Extras', 'Cigarros']; }
            datalist.innerHTML = uniqueCategories.map(c => `<option value="${c}"></option>`).join('');
        }

        // --- NAVEGACIÓN ---
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-400', 'border-indigo-500', 'border-t-2', 'md:border-t-0', 'md:border-r-4');
                btn.classList.add('text-slate-500', 'border-transparent', 'border-t-2', 'md:border-t-0', 'md:border-r-4');
            });
            const targetView = document.getElementById(`view-${viewName}`); if(targetView) targetView.classList.remove('hidden');
            const activeBtn = document.getElementById(`nav-${viewName}`);
            if(activeBtn) { activeBtn.classList.remove('text-slate-500', 'border-transparent'); activeBtn.classList.add('text-indigo-400', 'border-indigo-500'); }
            renderActiveViewOnly(viewName);
        }

        function renderActiveViewOnly(viewName) {
            const view = viewName || document.querySelector('.view-section:not(.hidden)')?.id.replace('view-', '') || 'ventas';
            if(view === 'ventas') renderPosProducts();
            if(view === 'almacen') renderAlmacen();
            if(view === 'soat') renderSoatHistory();
            if(view === 'agente') renderAgenteHistory();
            if(view === 'caja') renderCaja();
            if(view === 'analisis') renderAnalysis();
            if(view === 'respaldo') updateIcons();
        }

        // --- UTILIDADES ---
        function showModal(title, message) {
            document.getElementById('successTitle').textContent = title; document.getElementById('successMessage').innerHTML = message;
            const modal = document.getElementById('successModal'); modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.remove('scale-95'); modal.firstElementChild.classList.add('scale-100'); }, 10);
        }
        function closeSuccessModal() {
            const modal = document.getElementById('successModal'); modal.classList.add('opacity-0'); modal.firstElementChild.classList.remove('scale-100'); modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }
        function openConfigModal() {
            document.getElementById('cfg_soat').value = window.appConfig.soatMargin; 
            document.getElementById('cfg_agente').value = window.appConfig.agenteMargin;
            document.getElementById('cfg_tarjeta').value = window.appConfig.tarjetaMargin || 5;
            const modal = document.getElementById('configModal'); modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); modal.children[0].classList.add('scale-100'); }, 10);
        }
        function closeConfigModal() {
            const modal = document.getElementById('configModal'); modal.classList.add('opacity-0'); modal.children[0].classList.remove('scale-100'); modal.children[0].classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }
        function saveConfig() {
            const soatM = parseFloat(document.getElementById('cfg_soat').value); const agenteM = parseFloat(document.getElementById('cfg_agente').value); const tarjetaM = parseFloat(document.getElementById('cfg_tarjeta').value);
            if(!isNaN(soatM)) window.appConfig.soatMargin = soatM; if(!isNaN(agenteM)) window.appConfig.agenteMargin = agenteM; if(!isNaN(tarjetaM)) window.appConfig.tarjetaMargin = tarjetaM;
            saveData(); closeConfigModal(); setTimeout(() => { showModal('¡Ajustes Guardados!', `Comisiones y recargos actualizados correctamente.`); }, 300);
        }
        function showBreakdown(type, dateObj) {
            const tDate = dateObj || window.currentSelectedDayObj || new Date(); const tStr = tDate.toDateString();
            const sales = window.salesHistory.filter(s => s.date.toDateString() === tStr); const gastos = window.gastosHistory.filter(g => g.date.toDateString() === tStr);
            let efe = 0; let yap = 0; let tar = 0; let title = "";
            if (type === 'POS') {
                title = "Desglose Ingresos POS";
                sales.filter(s => s.type === 'POS').forEach(s => { const val = s.profit !== undefined ? s.profit : s.total; const m = (s.method || 'efectivo').toLowerCase(); if(m === 'efectivo') efe += val; else if(m === 'tarjeta') tar += val; else yap += val; });
            } else if (type === 'NETA') {
                title = "Desglose Caja Neta";
                sales.forEach(s => { const val = s.profit !== undefined ? s.profit : s.total; const m = (s.method || 'efectivo').toLowerCase(); if(m === 'efectivo') efe += val; else if(m === 'tarjeta') tar += val; else yap += val; });
                gastos.forEach(g => { const m = (g.method || 'efectivo').toLowerCase(); if(m === 'efectivo') efe -= g.monto; else if(m === 'tarjeta') tar -= g.monto; else yap -= g.monto; });
            }
            document.getElementById('brkTitle').textContent = title; document.getElementById('brkDate').textContent = tDate.toLocaleDateString('es-PE');
            document.getElementById('brkEfectivo').textContent = `S/ ${efe.toFixed(2)}`; document.getElementById('brkYape').textContent = `S/ ${yap.toFixed(2)}`; document.getElementById('brkTarjeta').textContent = `S/ ${tar.toFixed(2)}`;
            const modal = document.getElementById('breakdownModal'); modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); modal.children[0].classList.add('scale-100'); }, 10); updateIcons();
        }
        function closeBreakdownModal() { const modal = document.getElementById('breakdownModal'); modal.classList.add('opacity-0'); modal.children[0].classList.remove('scale-100'); modal.children[0].classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }

        function getCategoryColor(category) { const c = (category || '').toLowerCase(); if (c.includes('licor') || c.includes('cervez') || c.includes('ron')) return 'bg-amber-700/20 text-amber-500'; if (c.includes('gaseosa') || c.includes('agua')) return 'bg-red-700/20 text-red-500'; if (c.includes('snack') || c.includes('comestible') || c.includes('chicle')) return 'bg-orange-600/20 text-orange-500'; if (c.includes('extra') || c.includes('hielo') || c.includes('cigarro')) return 'bg-cyan-700/20 text-cyan-500'; return 'bg-slate-700/20 text-slate-500'; }
        function getCategoryIcon(category) { const c = (category || '').toLowerCase(); if (c.includes('licor') || c.includes('cervez') || c.includes('ron')) return 'wine'; if (c.includes('gaseosa') || c.includes('agua')) return 'glass-water'; if (c.includes('snack') || c.includes('comestible') || c.includes('chicle')) return 'cookie'; if (c.includes('extra') || c.includes('hielo') || c.includes('cigarro')) return 'snowflake'; return 'package'; }

        // --- ALMACÉN Y PRODUCTOS AVANZADOS ---
        function toggleAdvancedSales() {
            const sec = document.getElementById('advancedSalesSection'); const arrow = document.getElementById('advArrow');
            if (sec.classList.contains('hidden')) { sec.classList.remove('hidden'); arrow.classList.add('rotate-180'); } 
            else { sec.classList.add('hidden'); arrow.classList.remove('rotate-180'); }
        }
        function toggleGroupInputs() {
            const isG = document.getElementById('p_isGroup').checked; const div = document.getElementById('groupInputs');
            if(isG) div.classList.remove('hidden'); else div.classList.add('hidden');
        }

        // Descuentos por Cantidad UI
        function renderQtyDiscounts() {
            const list = document.getElementById('qtyDiscountsList'); list.innerHTML = '';
            window.modalDiscounts.forEach((d, index) => {
                list.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center gap-2 bg-slate-800 p-2 rounded border border-slate-700">
                        <span class="text-[10px] text-slate-400">Llevar</span>
                        <input type="number" min="2" value="${d.qty}" onchange="updateMDiscount(${index}, 'qty', this.value)" class="w-12 bg-slate-900 border border-slate-600 rounded text-xs text-center text-white p-1 focus:border-indigo-500">
                        <span class="text-[10px] text-slate-400">por S/</span>
                        <input type="number" min="0" step="0.1" value="${d.price}" onchange="updateMDiscount(${index}, 'price', this.value)" class="w-16 bg-slate-900 border border-slate-600 rounded text-xs text-center text-white p-1 focus:border-indigo-500">
                        <button type="button" onclick="removeQtyDiscount(${index})" class="ml-auto text-slate-500 hover:text-red-400"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>`);
            }); updateIcons();
        }
        function addQtyDiscount() { window.modalDiscounts.push({qty: 2, price: 0}); renderQtyDiscounts(); }
        function updateMDiscount(idx, field, val) { window.modalDiscounts[idx][field] = parseFloat(val); }
        function removeQtyDiscount(idx) { window.modalDiscounts.splice(idx, 1); renderQtyDiscounts(); }

        // Promos UI
        function renderPromos() {
            const list = document.getElementById('promosList'); list.innerHTML = '';
            const allProductsOpts = window.inventory.map(p => `<option value="${p.id}">${p.name} (${p.size})</option>`).join('');
            
            window.modalPromos.forEach((p, index) => {
                let itemsHtml = p.items.map((it, iIdx) => `
                    <div class="flex items-center gap-2 mt-1">
                        <select onchange="updateMPromoItem(${index}, ${iIdx}, 'id', this.value)" class="flex-1 bg-slate-900 border border-slate-600 rounded text-[10px] text-white p-1"><option value="">Seleccionar producto extra...</option>${allProductsOpts.replace(`value="${it.id}"`, `value="${it.id}" selected`)}</select>
                        <input type="number" min="1" value="${it.qty}" onchange="updateMPromoItem(${index}, ${iIdx}, 'qty', this.value)" class="w-10 bg-slate-900 border border-slate-600 rounded text-[10px] text-center text-white p-1" title="Cantidad">
                        <button type="button" onclick="removePromoItem(${index}, ${iIdx})" class="text-slate-500 hover:text-red-400"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>`).join('');

                list.insertAdjacentHTML('beforeend', `
                    <div class="bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="text" placeholder="Nombre Promo" value="${p.name}" onchange="updateMPromo(${index}, 'name', this.value)" class="flex-1 bg-slate-900 border border-slate-600 rounded text-xs text-white p-1">
                            <span class="text-[10px] text-slate-400">S/</span>
                            <input type="number" min="0" step="0.1" value="${p.price}" onchange="updateMPromo(${index}, 'price', this.value)" class="w-16 bg-slate-900 border border-slate-600 rounded text-xs text-center text-white p-1">
                            <button type="button" onclick="removePromoRow(${index})" class="text-slate-500 hover:text-red-400"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                        <div class="pl-2 border-l-2 border-indigo-500/30 space-y-1">
                            ${itemsHtml}
                            <button type="button" onclick="addPromoItem(${index})" class="text-[9px] text-indigo-400 hover:text-indigo-300 mt-1">+ Añadir producto extra a la promo</button>
                        </div>
                    </div>`);
            }); updateIcons();
        }
        function addPromoRow() { window.modalPromos.push({ id: generateId(), name: '', price: 0, items: [] }); renderPromos(); }
        function updateMPromo(idx, field, val) { window.modalPromos[idx][field] = field==='price'?parseFloat(val):val; }
        function removePromoRow(idx) { window.modalPromos.splice(idx, 1); renderPromos(); }
        function addPromoItem(idx) { window.modalPromos[idx].items.push({ id: '', qty: 1 }); renderPromos(); }
        function updateMPromoItem(pIdx, iIdx, field, val) { window.modalPromos[pIdx].items[iIdx][field] = field==='qty'?parseInt(val):val; }
        function removePromoItem(pIdx, iIdx) { window.modalPromos[pIdx].items.splice(iIdx, 1); renderPromos(); }


        function openAddProductModal(id = null) { 
            window.editingProductId = id; const title = document.getElementById('modalTitle');
            document.getElementById('advancedSalesSection').classList.add('hidden'); document.getElementById('advArrow').classList.remove('rotate-180');
            
            // Poblar datalist de categorías
            const datalist = document.getElementById('category-list');
            let uniqueCategories = [...new Set(window.inventory.map(p => p.category).filter(Boolean))];
            if (uniqueCategories.length === 0) { uniqueCategories = ['Licor', 'Gaseosa', 'Snack', 'Extras', 'Cigarros']; }
            datalist.innerHTML = uniqueCategories.map(c => `<option value="${c}"></option>`).join('');

            if (id) {
                const p = window.inventory.find(x => x.id == id);
                document.getElementById('p_name').value = p?.name||''; document.getElementById('p_size').value = p?.size||''; document.getElementById('p_category').value = p?.category||'';
                document.getElementById('p_price').value = p?.price||''; document.getElementById('p_stock').value = p?.stock||''; document.getElementById('p_minstock').value = p?.minStock||'';
                
                document.getElementById('p_isGroup').checked = !!p.isGroup;
                document.getElementById('p_unitsPerGroup').value = p.unitsPerGroup || '';
                document.getElementById('p_unitPrice').value = p.unitPrice || '';
                toggleGroupInputs();

                window.modalDiscounts = p.qtyDiscounts ? JSON.parse(JSON.stringify(p.qtyDiscounts)) : [];
                window.modalPromos = p.promos ? JSON.parse(JSON.stringify(p.promos)) : [];
                title.innerHTML = '<i data-lucide="edit" class="w-5 h-5 text-indigo-400"></i> Editar Producto';
            } else { 
                document.getElementById('newProductForm').reset(); title.innerHTML = '<i data-lucide="package-plus" class="w-5 h-5 text-indigo-400"></i> Añadir Nuevo Producto'; 
                document.getElementById('p_isGroup').checked = false; toggleGroupInputs();
                window.modalDiscounts = []; window.modalPromos = [];
            }
            renderQtyDiscounts(); renderPromos();
            document.getElementById('addProductModal').classList.remove('hidden'); updateIcons();
        }
        
        function closeAddProductModal() { document.getElementById('addProductModal').classList.add('hidden'); }
        
        function saveProduct() {
            const name = document.getElementById('p_name').value.trim(); const size = document.getElementById('p_size').value.trim(); const category = document.getElementById('p_category').value || 'Otros';
            const price = parseFloat(document.getElementById('p_price').value); const stock = parseInt(document.getElementById('p_stock').value); const minStock = parseInt(document.getElementById('p_minstock').value);
            const isGroup = document.getElementById('p_isGroup').checked;
            const unitsPerGroup = parseInt(document.getElementById('p_unitsPerGroup').value) || 1;
            const unitPrice = parseFloat(document.getElementById('p_unitPrice').value) || price;

            if(!name || !size || isNaN(price) || isNaN(stock) || isNaN(minStock)) return;

            const validPromos = window.modalPromos.map(p => ({...p, items: p.items.filter(i => i.id !== '')})).filter(p => p.name && !isNaN(p.price));
            const validDiscounts = window.modalDiscounts.filter(d => !isNaN(d.qty) && !isNaN(d.price));

            const prodData = { name, size, category, price, stock, minStock, color: getCategoryColor(category), isGroup, unitsPerGroup: isGroup?unitsPerGroup:1, unitPrice: isGroup?unitPrice:price, qtyDiscounts: validDiscounts, promos: validPromos };

            if (window.editingProductId) { 
                const idx = window.inventory.findIndex(x => x.id == window.editingProductId); 
                if(idx > -1) { window.inventory[idx] = { ...window.inventory[idx], ...prodData }; } 
                window.editingProductId = null; 
            } else { 
                window.inventory.push({ id: window.currentIdCounter++, ...prodData }); 
            }
            saveData(); closeAddProductModal(); renderActiveViewOnly();
        }

        function deleteProduct(id) { window.inventory = window.inventory.filter(p => p.id != id); window.cart = window.cart.filter(c => c.product.id != id); updateCartUI(); saveData(); renderActiveViewOnly(); }
        function filterLowStock() { window.isLowStockFilterActive = !window.isLowStockFilterActive; const card = document.getElementById('lowStockCard'); const icon = document.getElementById('lowStockIcon'); if (window.isLowStockFilterActive) { card.classList.add('bg-red-900/40', 'border-red-500'); card.classList.remove('bg-slate-800', 'border-slate-700'); icon.classList.add('text-red-400'); icon.classList.remove('text-slate-500'); } else { card.classList.remove('bg-red-900/40', 'border-red-500'); card.classList.add('bg-slate-800', 'border-slate-700'); icon.classList.remove('text-red-400'); icon.classList.add('text-slate-500'); } renderAlmacen(); }
        
        function renderAlmacen() {
            const searchTerm = document.getElementById('almacenSearchInput').value.toLowerCase();
            const categoryTerm = document.getElementById('almacenCategoryFilter').value;
            const tbody = document.getElementById('almacenTableBody'); tbody.innerHTML = '';

            let filtered = window.inventory; 
            if (window.isLowStockFilterActive) filtered = filtered.filter(p => p.stock <= p.minStock); 
            
            filtered = filtered.filter(p => {
                const matchSearch = p.name?.toLowerCase().includes(searchTerm) || p.size?.toLowerCase().includes(searchTerm);
                const matchCategory = categoryTerm === '' || p.category === categoryTerm;
                return matchSearch && matchCategory;
            });

            let lowStockCount = window.inventory.filter(p => p.stock <= p.minStock).length;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500 text-sm">No hay productos.</td></tr>`;
            }

            filtered.forEach(p => {
                const isLowStock = p.stock <= p.minStock;
                const statusHtml = isLowStock ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-red-500/10 text-red-500 border border-red-500/20"><i data-lucide="alert-circle" class="w-3 h-3"></i> Poco Stock</span>` : `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><i data-lucide="check-circle" class="w-3 h-3"></i> Normal</span>`;
                
                let stockText = `<span class="font-bold text-base md:text-lg ${isLowStock ? 'text-red-400' : 'text-white'}">${p.stock}</span>`;
                if (p.isGroup && p.unitsPerGroup > 1) {
                    const packs = Math.floor(p.stock / p.unitsPerGroup); const units = p.stock % p.unitsPerGroup;
                    stockText = `<div class="flex flex-col items-center leading-tight"><span class="font-bold ${isLowStock ? 'text-red-400' : 'text-white'}">${packs} pq.</span><span class="text-[9px] text-slate-400">${units} u.</span></div>`;
                }

                const tr = document.createElement('tr'); tr.className = 'hover:bg-slate-800/50 transition-colors group border-b border-slate-700/50';
                tr.innerHTML = `<td class="p-3 md:p-4"><div class="flex items-center gap-2 md:gap-3"><div class="${p.color} w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center flex-shrink-0"><i data-lucide="${getCategoryIcon(p.category)}" class="w-4 h-4 md:w-5 md:h-5"></i></div><div><p class="font-bold text-sm md:text-base text-slate-200 group-hover:text-indigo-400 truncate max-w-[120px] md:max-w-[200px]">${p.name}</p><p class="text-[10px] md:text-xs text-slate-500">${p.size} ${p.promos?.length>0?' • <span class="text-indigo-400">Promos</span>':''}</p></div></div></td><td class="p-3 md:p-4 text-slate-400 capitalize text-xs md:text-sm">${p.category}</td><td class="p-3 md:p-4 text-right font-medium text-slate-300 text-xs md:text-sm">S/ ${p.price.toFixed(2)}</td><td class="p-3 md:p-4 text-center align-middle">${stockText}</td><td class="p-3 md:p-4">${statusHtml}</td><td class="p-3 md:p-4 text-center"><div class="flex items-center justify-center gap-1 md:gap-2"><button onclick="openAddProductModal(${p.id})" class="text-slate-500 hover:text-indigo-400 transition-colors p-1.5 md:p-2 rounded-lg hover:bg-slate-700"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteProduct(${p.id})" class="text-slate-500 hover:text-red-400 transition-colors p-1.5 md:p-2 rounded-lg hover:bg-slate-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('stat-total-products').textContent = window.inventory.length; document.getElementById('stat-low-stock').textContent = lowStockCount; updateIcons();
        }

        // --- VENTAS POS ---
        function renderPosProducts() {
            const grid = document.getElementById('productsGrid'); grid.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryTerm = document.getElementById('posCategoryFilter').value;
            
            if (window.inventory.length === 0) { grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-slate-500 min-h-[200px]"><i data-lucide="package-search" class="w-12 h-12 mb-4 opacity-50"></i><p class="text-sm text-center">Agrega inventario en <strong>Almacén</strong></p></div>`; updateIcons(); return; }

            // Calcular ventas históricas para ordenar (Top Sellers)
            const salesCount = {};
            window.salesHistory.filter(s => s.type === 'POS').forEach(sale => {
                if(sale.items) {
                    sale.items.forEach(item => {
                        if (item.product && item.product.id) {
                            salesCount[item.product.id] = (salesCount[item.product.id] || 0) + item.qty;
                        }
                    });
                }
            });

            let filteredProducts = window.inventory.filter(p => {
                const matchSearch = p.name?.toLowerCase().includes(searchTerm) || p.size?.toLowerCase().includes(searchTerm);
                const matchCategory = categoryTerm === '' || p.category === categoryTerm;
                return matchSearch && matchCategory;
            });

            // Ordenar por Top Sellers (Mayor a Menor)
            filteredProducts.sort((a, b) => {
                const countA = salesCount[a.id] || 0;
                const countB = salesCount[b.id] || 0;
                return countB - countA;
            });

            filteredProducts.forEach(product => {
                let unitsInCart = window.cart.filter(item => item.product?.id == product.id).reduce((sum, item) => {
                    if (item.type === 'package') return sum + (item.qty * product.unitsPerGroup);
                    return sum + item.qty;
                }, 0);
                const stockAvailable = product.stock - unitsInCart;
                const isOutOfStock = stockAvailable <= 0;

                let stockText = `Stk: ${stockAvailable}`;
                if (product.isGroup && product.unitsPerGroup > 1) {
                    stockText = `Stk: ${Math.floor(stockAvailable/product.unitsPerGroup)}p y ${stockAvailable%product.unitsPerGroup}u`;
                }

                const card = document.createElement('div'); card.id = `prod-card-${product.id}`; card.className = `bg-slate-800 border ${isOutOfStock ? 'border-red-900/50 opacity-60 cursor-not-allowed' : 'border-slate-700 hover:border-indigo-500 cursor-pointer hover:shadow-lg active:scale-95'} rounded-xl p-3 md:p-4 transition-all group flex flex-col justify-between h-32 md:h-40 relative overflow-hidden select-none`;
                card.addEventListener('click', () => addToCart(product.id));

                card.innerHTML = `<div class="flex justify-between items-start mb-1 md:mb-2 relative z-10 pointer-events-none"><div class="${product.color} w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center"><i data-lucide="${getCategoryIcon(product.category)}" class="w-4 h-4 md:w-6 md:h-6"></i></div><span class="bg-slate-900 text-slate-300 text-[9px] md:text-xs px-1.5 md:px-2 py-0.5 md:py-1 rounded border border-slate-700">${product.size}</span></div><div class="relative z-10 pointer-events-none"><h3 class="font-bold text-slate-200 text-xs md:text-sm leading-tight group-hover:text-indigo-400 line-clamp-2">${product.name}</h3><div class="flex justify-between items-end mt-1"><p class="text-emerald-400 font-bold text-sm md:text-lg">S/ ${product.price.toFixed(2)}</p><span class="text-[9px] md:text-xs font-medium ${isOutOfStock ? 'text-red-400' : 'text-slate-400'}">${isOutOfStock ? 'Agotado' : stockText}</span></div></div>${isOutOfStock ? `<div class="absolute inset-0 bg-slate-900/40 z-0 pointer-events-none"></div>` : ''}`;
                grid.appendChild(card);
            }); updateIcons();
        }

        function addToCart(productId) {
            const p = window.inventory.find(x => x.id == productId); if (!p) return;
            
            let defaultType = 'unit'; 
            let unitsInCart = window.cart.filter(item => item.product?.id == productId).reduce((sum, item) => sum + (item.type==='package'?item.qty*p.unitsPerGroup : item.qty), 0);
            if (unitsInCart >= p.stock) { const card = document.getElementById(`prod-card-${productId}`); if(card) { card.classList.add('animate-[shake_0.4s_ease-in-out]'); setTimeout(() => card.classList.remove('animate-[shake_0.4s_ease-in-out]'), 400); } return; }

            const existingItem = window.cart.find(x => x.product?.id == productId && x.type === defaultType && !x.promoId);
            if (existingItem) existingItem.qty++; 
            else window.cart.push({ id: generateId(), product: p, type: defaultType, promoId: null, qty: 1 });
            
            updateCartUI(); renderPosProducts();
        }
        
        function changeCartItemQty(cartId, delta) {
            const index = window.cart.findIndex(x => x.id === cartId);
            if (index > -1) { 
                const item = window.cart[index]; const p = item.product;
                let unitsNeeded = delta > 0 ? (item.type === 'package' ? p.unitsPerGroup : 1) : 0;
                if (delta > 0) {
                    let unitsInCart = window.cart.filter(x => x.product?.id == p.id).reduce((sum, it) => sum + (it.type==='package'?it.qty*p.unitsPerGroup : it.qty), 0);
                    if (unitsInCart + unitsNeeded > p.stock) return; 
                }
                item.qty += delta; 
                if (item.qty <= 0) window.cart.splice(index, 1); 
                updateCartUI(); renderPosProducts(); 
            }
        }

        function changeCartItemMode(cartId, val) {
            const item = window.cart.find(x => x.id === cartId); if(!item) return;
            if (val === 'unit') { item.type = 'unit'; item.promoId = null; }
            else if (val === 'package') { item.type = 'package'; item.promoId = null; }
            else if (val.startsWith('promo_')) { item.type = 'promo'; item.promoId = val.replace('promo_',''); }
            updateCartUI(); renderPosProducts();
        }

        function calculateItemTotal(item) {
            const p = item.product;
            if (item.type === 'package') return p.price * item.qty;
            if (item.type === 'promo') {
                const promo = p.promos?.find(pr => pr.id === item.promoId);
                return promo ? promo.price * item.qty : 0;
            }
            let total = 0; let remQty = item.qty;
            if (p.qtyDiscounts && p.qtyDiscounts.length > 0) {
                const rules = [...p.qtyDiscounts].sort((a,b) => b.qty - a.qty);
                for (let r of rules) {
                    if (remQty >= r.qty) {
                        let packs = Math.floor(remQty / r.qty);
                        total += packs * r.price;
                        remQty %= r.qty;
                    }
                }
            }
            total += remQty * p.unitPrice; 
            return total;
        }

        function updateCartUI() {
            const container = document.getElementById('cartItems'); const empty = document.getElementById('emptyCart'); const btn = document.getElementById('checkoutBtn');
            container.innerHTML = ''; let subtotal = 0;

            if (window.cart.length === 0) { 
                empty.classList.remove('hidden'); container.classList.add('hidden'); btn.disabled = true; btn.className = 'flex-1 py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg text-slate-400 bg-slate-700 opacity-50 cursor-not-allowed transition-all flex items-center justify-center gap-2'; btn.innerHTML = '<i data-lucide="check-circle-2" class="w-5 h-5 md:w-6 md:h-6"></i> Cobrar'; 
                document.getElementById('subtotalAmount').textContent = `S/ 0.00`; document.getElementById('totalAmount').textContent = `S/ 0.00`;
                document.getElementById('tarjetaFeeRow').classList.add('hidden');
                return;
            } 
            
            empty.classList.add('hidden'); container.classList.remove('hidden'); btn.disabled = false; btn.className = 'flex-1 py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg text-white bg-emerald-600 hover:bg-emerald-500 transition-all flex items-center justify-center gap-2 shadow-lg';
            
            window.cart.forEach(item => {
                const p = item.product;
                const itemTotal = calculateItemTotal(item); subtotal += itemTotal; 
                
                let unitsInCart = window.cart.filter(x => x.product?.id == p.id).reduce((sum, it) => sum + (it.type==='package'?it.qty*p.unitsPerGroup : it.qty), 0);
                let neededForNext = item.type === 'package' ? p.unitsPerGroup : 1;
                const isMax = (unitsInCart + neededForNext) > p.stock;

                let selectOptions = '';
                if (p.isGroup) {
                    selectOptions += `<option value="unit" ${item.type==='unit'?'selected':''}>Unidad (S/ ${p.unitPrice.toFixed(2)})</option>`;
                    selectOptions += `<option value="package" ${item.type==='package'?'selected':''}>Paquete x${p.unitsPerGroup} (S/ ${p.price.toFixed(2)})</option>`;
                } else {
                    selectOptions += `<option value="unit" ${item.type==='unit'?'selected':''}>Normal (S/ ${p.unitPrice.toFixed(2)})</option>`;
                }
                
                if (p.promos && p.promos.length > 0) {
                    selectOptions += `<optgroup label="Promociones">`;
                    p.promos.forEach(pr => { selectOptions += `<option value="promo_${pr.id}" ${item.promoId===pr.id?'selected':''}>⭐ ${pr.name} (S/ ${pr.price.toFixed(2)})</option>`; });
                    selectOptions += `</optgroup>`;
                }

                let itemName = p.name;
                let itemDesc = p.size;

                if (item.type === 'promo') {
                    const promo = p.promos?.find(pr => pr.id === item.promoId);
                    if (promo) {
                        itemName = `⭐ ${promo.name} (${p.name})`;
                        if (promo.items && promo.items.length > 0) {
                            const extraNames = promo.items.map(pi => {
                                const invItem = window.inventory.find(x => x.id == pi.id);
                                return invItem ? `${pi.qty}x ${invItem.name}` : '';
                            }).filter(Boolean).join(' + ');
                            if (extraNames) itemDesc += ` + ${extraNames}`;
                        }
                    }
                } else if (item.type === 'package') {
                    itemDesc += ` (Pq. x${p.unitsPerGroup})`;
                }

                const div = document.createElement('div'); div.className = 'bg-slate-900 border border-slate-700 rounded-lg p-2 md:p-3 flex flex-col gap-2';
                div.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0 pr-2">
                            <h4 class="text-xs md:text-sm font-bold text-white truncate" title="${itemName}">${itemName}</h4>
                            <div class="flex text-[10px] md:text-xs text-slate-400 gap-1 md:gap-2 mt-0.5 truncate" title="${itemDesc}">
                                <span>${itemDesc}</span>
                            </div>
                            <select onchange="changeCartItemMode('${item.id}', this.value)" class="mt-1 w-full bg-slate-800 text-indigo-300 text-[10px] md:text-xs rounded border border-slate-600 p-1 focus:outline-none focus:border-indigo-500">
                                ${selectOptions}
                            </select>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="font-bold text-emerald-400 text-sm md:text-base">S/ ${itemTotal.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex justify-end items-center">
                        <div class="flex items-center bg-slate-800 rounded-md border border-slate-600 overflow-hidden h-6 md:h-7">
                            <button onclick="changeCartItemQty('${item.id}', -1)" class="w-7 h-full text-slate-300 hover:text-white hover:bg-slate-700 transition-colors flex items-center justify-center"><i data-lucide="minus" class="w-3 h-3"></i></button>
                            <span class="w-8 text-center text-xs md:text-sm font-bold text-white bg-slate-900 h-full flex items-center justify-center">${item.qty}</span>
                            <button onclick="changeCartItemQty('${item.id}', 1)" class="${isMax ? 'text-slate-600 bg-slate-800 cursor-not-allowed' : 'text-slate-300 hover:text-white hover:bg-slate-700'} transition-colors w-7 h-full flex items-center justify-center"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            
            const method = document.querySelector('input[name="payment"]:checked').value;
            let surcharge = 0;
            const tRow = document.getElementById('tarjetaFeeRow');
            if (method === 'tarjeta') {
                const margin = window.appConfig.tarjetaMargin || 5;
                surcharge = subtotal * (margin / 100);
                
                // Redondeo especial hacia la décima superior (.80, 1.00)
                surcharge = Math.ceil(surcharge * 10) / 10; 
                
                document.getElementById('tarjetaFeePercent').textContent = margin;
                document.getElementById('tarjetaFeeAmount').textContent = `S/ ${surcharge.toFixed(2)}`;
                tRow.classList.remove('hidden');
            } else {
                tRow.classList.add('hidden');
            }

            const totalFinal = subtotal + surcharge;
            document.getElementById('subtotalAmount').textContent = `S/ ${subtotal.toFixed(2)}`; 
            document.getElementById('totalAmount').textContent = `S/ ${totalFinal.toFixed(2)}`; 
            btn.innerHTML = `<i data-lucide="credit-card" class="w-5 h-5 md:w-6 md:h-6"></i> Cobrar S/ ${totalFinal.toFixed(2)}`;
            updateIcons();
        }

        function cancelEditPos() {
            if (window.editingPos) { window.salesHistory.push(window.editingPos.originalData); saveData(); window.editingPos = null; }
            window.cart = []; updateCartUI(); document.getElementById('searchInput').value = ''; document.getElementById('ventasHeaderTitle').textContent = 'Nueva Venta'; document.getElementById('cancelEditBtn').classList.add('hidden'); renderPosProducts();
        }

        document.getElementById('checkoutBtn').addEventListener('click', () => {
            if (window.cart.length === 0) return;
            const method = document.querySelector('input[name="payment"]:checked').value; 
            
            let subtotal = 0;
            window.cart.forEach(item => subtotal += calculateItemTotal(item));
            let surcharge = 0;
            if (method === 'tarjeta') {
                surcharge = subtotal * ((window.appConfig.tarjetaMargin || 5) / 100);
                surcharge = Math.ceil(surcharge * 10) / 10;
            }
            const total = subtotal + surcharge;
            
            let lowStockAlerts = [];

            window.cart.forEach(item => { 
                const p = item.product;
                const inv = window.inventory.find(x => x.id == p.id); 
                if(inv) {
                    if (item.type === 'package') inv.stock -= (item.qty * inv.unitsPerGroup);
                    else inv.stock -= item.qty; 
                    
                    if (inv.stock <= inv.minStock && !lowStockAlerts.includes(inv.name)) lowStockAlerts.push(inv.name);
                }
                if (item.type === 'promo') {
                    const promo = p.promos?.find(pr => pr.id === item.promoId);
                    if (promo && promo.items) {
                        promo.items.forEach(pi => {
                            const lInv = window.inventory.find(x => x.id == pi.id);
                            if (lInv) {
                                lInv.stock -= (item.qty * pi.qty);
                                if (lInv.stock <= lInv.minStock && !lowStockAlerts.includes(lInv.name)) lowStockAlerts.push(lInv.name);
                            }
                        });
                    }
                }
            });
            
            const txId = window.editingPos ? window.editingPos.id : Date.now();
            const txDate = window.editingPos ? new Date(window.editingPos.date) : new Date();
            
            window.salesHistory.push({ id: txId, date: txDate, type: 'POS', total: total, profit: total, method: method, items: [...window.cart] });
            saveData();
            window.editingPos = null;

            let successMsg = `Ingreso de <strong class="text-white">S/ ${total.toFixed(2)}</strong> (${method}).`;
            if (lowStockAlerts.length > 0) successMsg += `<div class="mt-4 bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-lg text-xs md:text-sm text-left"><p class="font-bold flex items-center gap-1 mb-1"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Poco Stock en:</p><span class="text-white">${lowStockAlerts.join(', ')}</span></div>`;
            showModal('¡Venta Exitosa!', successMsg);
            
            window.cart = []; 
            document.getElementById('ventasHeaderTitle').textContent = 'Nueva Venta';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            updateCartUI(); 
            document.getElementById('searchInput').value = ''; 
            renderActiveViewOnly(); 
        });

        // --- SOAT ---
        function cancelEditSoat() { if (window.editingSoat) { window.salesHistory.push(window.editingSoat.originalData); saveData(); window.editingSoat = null; } document.getElementById('soatForm').reset(); document.getElementById('soatHeaderTitle').innerHTML = '<i data-lucide="file-text" class="w-5 h-5 text-indigo-400"></i> Nuevo SOAT'; document.getElementById('soatBtnText').textContent = 'Registrar SOAT'; document.getElementById('cancelSoatEditBtn').classList.add('hidden'); renderActiveViewOnly(); }
        function registerSoat() {
            const placa = document.getElementById('soat_placa').value.toUpperCase().trim(); const tipo = document.getElementById('soat_tipo').value; const dni = document.getElementById('soat_dni').value.trim(); const desc = document.getElementById('soat_desc').value.trim(); const precio = parseFloat(document.getElementById('soat_precio').value); const method = document.querySelector('input[name="soatPayment"]:checked').value;
            if(!placa || !dni || isNaN(precio)) return;
            const profit = precio * (window.appConfig.soatMargin / 100); const txId = window.editingSoat ? window.editingSoat.id : Date.now(); const txDate = window.editingSoat ? new Date(window.editingSoat.date) : new Date();
            window.salesHistory.push({ id: txId, date: txDate, type: 'SOAT', placa, tipoVehiculo: tipo, dni, soatDesc: desc, total: precio, profit: profit, method: method }); saveData(); window.editingSoat = null;
            document.getElementById('soatForm').reset(); document.getElementById('soatHeaderTitle').innerHTML = '<i data-lucide="file-text" class="w-5 h-5 text-indigo-400"></i> Nuevo SOAT'; document.getElementById('soatBtnText').textContent = 'Registrar SOAT'; document.getElementById('cancelSoatEditBtn').classList.add('hidden');
            showModal('¡SOAT Registrado!', `Póliza cobrada: <strong class="text-white">S/ ${precio.toFixed(2)}</strong><br>Ganancia Neta: <strong class="text-emerald-400">S/ ${profit.toFixed(2)}</strong>`); renderActiveViewOnly();
        }
        function renderSoatHistory() {
            const list = document.getElementById('soatHistoryList'); const hoy = new Date().toDateString(); const soatsHoy = window.salesHistory.filter(s => s.date?.toDateString() === hoy && s.type === 'SOAT').sort((a,b) => b.date - a.date);
            if (soatsHoy.length === 0) { list.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm">Sin ventas hoy.</div>`; return; }
            list.innerHTML = ''; soatsHoy.forEach(s => {
                const ganancia = s.profit !== undefined ? s.profit : s.total; 
                const div = document.createElement('div'); div.className = "bg-slate-900 border border-slate-700 p-3 md:p-4 rounded-lg flex justify-between items-center group cursor-pointer hover:border-indigo-500 transition-colors"; div.onclick = () => showTransactionDetails(s.id, 'SOAT');
                div.innerHTML = `<div class="flex items-center gap-3"><div class="bg-indigo-500/20 text-indigo-400 p-2 rounded-lg"><i data-lucide="shield-check" class="w-4 h-4 md:w-5 md:h-5"></i></div><div><p class="font-bold text-white text-xs md:text-sm">Placa: ${s.placa}</p><p class="text-[10px] md:text-xs text-slate-400">${s.tipoVehiculo} • ${s.dni}</p></div></div><div class="text-right flex flex-col items-end gap-1"><p class="font-bold text-slate-300 line-through decoration-slate-500 text-[10px] md:text-xs">S/ ${s.total.toFixed(2)}</p><p class="font-bold text-emerald-400 text-sm md:text-base">+S/ ${ganancia.toFixed(2)}</p></div>`; list.appendChild(div);
            }); updateIcons();
        }

        // --- AGENTE ---
        function cancelEditAgente() { if (window.editingAgente) { window.salesHistory.push(window.editingAgente.originalData); saveData(); window.editingAgente = null; } document.getElementById('agenteForm').reset(); document.getElementById('agenteHeaderTitle').innerHTML = '<i data-lucide="landmark" class="w-5 h-5 text-bcp"></i> Nueva Operación'; document.getElementById('agenteBtnText').textContent = 'Registrar Operación'; document.getElementById('cancelAgenteEditBtn').classList.add('hidden'); renderActiveViewOnly(); }
        function registerAgente() {
            const banco = document.getElementById('agente_banco').value; const tipo = document.getElementById('agente_tipo').value; const docNum = document.getElementById('agente_doc').value.trim(); const monto = parseFloat(document.getElementById('agente_monto').value); const method = document.querySelector('input[name="agentePayment"]:checked').value;
            if(!docNum || isNaN(monto)) return;
            const profit = monto * (window.appConfig.agenteMargin / 100); const txId = window.editingAgente ? window.editingAgente.id : Date.now(); const txDate = window.editingAgente ? new Date(window.editingAgente.date) : new Date();
            window.salesHistory.push({ id: txId, date: txDate, type: 'AGENTE', banco: banco, tipoOperacion: tipo, doc: docNum, total: monto, profit: profit, method: method }); saveData(); window.editingAgente = null;
            document.getElementById('agenteForm').reset(); document.getElementById('agenteHeaderTitle').innerHTML = '<i data-lucide="landmark" class="w-5 h-5 text-bcp"></i> Nueva Operación'; document.getElementById('agenteBtnText').textContent = 'Registrar Operación'; document.getElementById('cancelAgenteEditBtn').classList.add('hidden');
            showModal('¡Operación Exitosa!', `Operación: <strong class="text-white">S/ ${monto.toFixed(2)}</strong><br>Ganancia Neta: <strong class="text-emerald-400">S/ ${profit.toFixed(2)}</strong>`); renderActiveViewOnly();
        }
        function renderAgenteHistory() {
            const list = document.getElementById('agenteHistoryList'); const hoy = new Date().toDateString(); const agenteHoy = window.salesHistory.filter(s => s.date?.toDateString() === hoy && s.type === 'AGENTE').sort((a,b) => b.date - a.date);
            if (agenteHoy.length === 0) { list.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm">Sin operaciones hoy.</div>`; return; }
            list.innerHTML = ''; agenteHoy.forEach(s => {
                const ganancia = s.profit !== undefined ? s.profit : 0; let iconStr = 'arrow-right-left'; if(s.tipoOperacion === 'Depósito') iconStr = 'arrow-up-circle'; if(s.tipoOperacion === 'Retiro') iconStr = 'arrow-down-circle';
                const div = document.createElement('div'); div.className = "bg-slate-900 border border-slate-700 p-3 md:p-4 rounded-lg flex justify-between items-center group cursor-pointer hover:border-bcp transition-colors"; div.onclick = () => showTransactionDetails(s.id, 'AGENTE');
                div.innerHTML = `<div class="flex items-center gap-3"><div class="bg-orange-500/20 text-bcp p-2 rounded-lg"><i data-lucide="${iconStr}" class="w-4 h-4 md:w-5 md:h-5"></i></div><div><p class="font-bold text-white text-xs md:text-sm">${s.tipoOperacion}</p><p class="text-[10px] md:text-xs text-slate-400">${s.banco} • ${s.doc}</p></div></div><div class="text-right flex flex-col items-end gap-1"><p class="font-bold text-slate-300 text-[10px] md:text-xs">S/ ${s.total.toFixed(2)}</p><p class="font-bold text-emerald-400 text-sm md:text-base">+S/ ${ganancia.toFixed(2)}</p></div>`; list.appendChild(div);
            }); updateIcons();
        }

        // --- CAJA ---
        function cancelEditGasto() { if (window.editingGasto) { window.gastosHistory.push(window.editingGasto.originalData); saveData(); window.editingGasto = null; } document.getElementById('gastoDesc').value = ''; document.getElementById('gastoMonto').value = ''; document.getElementById('gastoHeaderTitle').textContent = 'Registrar Gasto de Tienda'; document.getElementById('btnGasto').textContent = 'Añadir'; document.getElementById('btnGasto').classList.replace('bg-indigo-600', 'bg-slate-700'); document.getElementById('cancelGastoEditBtn').classList.add('hidden'); renderActiveViewOnly(); }
        function renderCaja() {
            const hoy = new Date().toDateString(); const ventasHoy = window.salesHistory.filter(s => s.date?.toDateString() === hoy);
            const totalPos = ventasHoy.filter(s => s.type === 'POS').reduce((sum, s) => sum + (s.profit !== undefined ? s.profit : s.total), 0); const totalSoatProfit = ventasHoy.filter(s => s.type === 'SOAT').reduce((sum, s) => sum + (s.profit || 0), 0); const totalAgenteProfit = ventasHoy.filter(s => s.type === 'AGENTE').reduce((sum, s) => sum + (s.profit || 0), 0);
            const gastosHoy = window.gastosHistory.filter(g => g.date?.toDateString() === hoy); const totalEgresos = gastosHoy.reduce((sum, g) => sum + g.monto, 0);
            const totalCajaNeta = totalPos + totalSoatProfit + totalAgenteProfit - totalEgresos;
            document.getElementById('caja-ingresos-pos').textContent = `S/ ${totalPos.toFixed(2)}`; document.getElementById('caja-ingresos-soat').textContent = `S/ ${totalSoatProfit.toFixed(2)}`; document.getElementById('caja-ingresos-agente').textContent = `S/ ${totalAgenteProfit.toFixed(2)}`; document.getElementById('caja-gastos-totales').textContent = `S/ ${totalEgresos.toFixed(2)}`; document.getElementById('caja-total').textContent = `S/ ${totalCajaNeta.toFixed(2)}`;
            const lista = document.getElementById('listaGastos'); lista.innerHTML = '';
            if (gastosHoy.length === 0) { lista.innerHTML = `<div class="text-center text-slate-500 py-4 text-sm">Sin gastos hoy.</div>`; }
            gastosHoy.sort((a,b) => b.date - a.date).forEach(g => {
                lista.innerHTML += `<div class="flex justify-between items-center bg-slate-900 border border-slate-700 p-2.5 md:p-3 rounded-lg text-xs md:text-sm group transition-colors cursor-pointer hover:border-red-500" onclick="showTransactionDetails(${g.id}, 'GASTO')"><span class="text-slate-300 font-medium">${g.desc} <span class="text-[9px] md:text-[10px] text-slate-500 uppercase ml-1">(${g.method || 'efectivo'})</span></span><div class="flex items-center gap-3"><span class="font-bold text-red-400">- S/ ${g.monto.toFixed(2)}</span></div></div>`;
            }); updateIcons();
        }
        function registrarGasto() {
            const desc = document.getElementById('gastoDesc').value.trim(); const monto = parseFloat(document.getElementById('gastoMonto').value); const method = document.querySelector('input[name="gastoPayment"]:checked').value;
            if(!desc || isNaN(monto)) return;
            const txId = window.editingGasto ? window.editingGasto.id : Date.now(); const txDate = window.editingGasto ? new Date(window.editingGasto.date) : new Date();
            window.gastosHistory.push({ id: txId, date: txDate, desc, monto, method }); saveData(); window.editingGasto = null;
            document.getElementById('gastoDesc').value = ''; document.getElementById('gastoMonto').value = ''; document.getElementById('gastoHeaderTitle').textContent = 'Registrar Gasto de Tienda'; document.getElementById('btnGasto').textContent = 'Añadir'; document.getElementById('btnGasto').classList.replace('bg-indigo-600', 'bg-slate-700'); document.getElementById('cancelGastoEditBtn').classList.add('hidden'); renderActiveViewOnly();
        }
        function cerrarCaja() { showModal('Caja Cerrada', 'El turno se ha cerrado exitosamente.'); }

        // --- ANÁLISIS ---
        const isValidDate = (d) => d && typeof d.getFullYear === 'function' && !isNaN(d);
        function changeMonth(delta) { window.currentCalDate.setMonth(window.currentCalDate.getMonth() + delta); renderAnalysis(); }
        function renderAnalysis() {
            const grid = document.getElementById('calendarGrid'); if(!grid) return; 
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const year = window.currentCalDate.getFullYear(); const month = window.currentCalDate.getMonth();
            document.getElementById('calendarMonthLabel').textContent = `${monthNames[month]} ${year}`;
            const monthSales = window.salesHistory.filter(s => isValidDate(s.date) && s.date.getFullYear() === year && s.date.getMonth() === month); const monthGastos = window.gastosHistory.filter(g => isValidDate(g.date) && g.date.getFullYear() === year && g.date.getMonth() === month);
            const totalIngresos = monthSales.reduce((sum, s) => sum + (s.profit !== undefined ? s.profit : s.total), 0); const totalGastos = monthGastos.reduce((sum, g) => sum + g.monto, 0); const totalMesNeta = totalIngresos - totalGastos;
            document.getElementById('analisis-total-mes').textContent = `S/ ${totalMesNeta.toFixed(2)}`; grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { grid.insertAdjacentHTML('beforeend', `<div class="p-1 md:p-2 border border-slate-800/50 rounded-lg bg-slate-900/30"></div>`); }
            const hoyStr = new Date().toDateString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day); const isToday = dayDate.toDateString() === hoyStr;
                const daySales = monthSales.filter(s => s.date.getDate() === day); const dayGastosArr = monthGastos.filter(g => g.date.getDate() === day);
                let classes = ''; if(daySales.length > 0) classes += ' has-sales'; if(dayGastosArr.length > 0) classes += ' has-gastos'; if (window.currentSelectedDayObj && dayDate.toDateString() === window.currentSelectedDayObj.toDateString()) { classes += ' ring-2 ring-indigo-500'; }
                const div = document.createElement('div'); div.className = `calendar-day p-1 md:p-2 h-10 sm:h-14 lg:h-20 border border-slate-700/50 rounded-lg flex flex-col cursor-pointer transition-colors ${isToday ? 'bg-indigo-900/40 border-indigo-500' : 'bg-slate-800 hover:bg-slate-700'} ${classes}`; div.onclick = () => showDayDetails(dayDate, daySales, dayGastosArr);
                let htmlInner = `<span class="text-xs md:text-sm font-bold ${isToday ? 'text-indigo-400' : 'text-slate-300'}">${day}</span>`;
                if(daySales.length > 0 || dayGastosArr.length > 0) { const dayTotal = daySales.reduce((sum, s) => sum + (s.profit !== undefined ? s.profit : s.total), 0) - dayGastosArr.reduce((sum, g) => sum + g.monto, 0); htmlInner += `<span class="text-[8px] md:text-[10px] ${dayTotal >= 0 ? 'text-emerald-500' : 'text-red-400'} font-medium mt-auto hidden lg:block">S/ ${dayTotal.toFixed(0)}</span>`; }
                div.innerHTML = htmlInner; grid.appendChild(div);
            }
            if (window.currentSelectedDayObj) { const sSales = window.salesHistory.filter(s => isValidDate(s.date) && s.date.toDateString() === window.currentSelectedDayObj.toDateString()); const sGastos = window.gastosHistory.filter(g => isValidDate(g.date) && g.date.toDateString() === window.currentSelectedDayObj.toDateString()); showDayDetails(window.currentSelectedDayObj, sSales, sGastos); }
        }

        function showDayDetails(dateObj, daySales, dayGastosArr) {
            window.currentSelectedDayObj = dateObj; document.getElementById('selectedDateLabel').textContent = dateObj.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500'));
            const totalIngresos = daySales.reduce((sum, s) => sum + (s.profit !== undefined ? s.profit : s.total), 0); const totalGastos = dayGastosArr.reduce((sum, g) => sum + g.monto, 0); const totalNeto = totalIngresos - totalGastos;
            document.getElementById('selectedDayIngresos').textContent = `S/ ${totalIngresos.toFixed(2)}`; document.getElementById('selectedDayGastos').textContent = `S/ ${totalGastos.toFixed(2)}`; document.getElementById('selectedDayNeto').textContent = `S/ ${totalNeto.toFixed(2)}`; document.getElementById('selectedDayCount').textContent = daySales.length + dayGastosArr.length;
            const list = document.getElementById('selectedDayTransactions'); list.innerHTML = '';
            if (daySales.length === 0 && dayGastosArr.length === 0) { list.innerHTML = `<div class="h-full flex items-center justify-center text-slate-500 text-xs md:text-sm text-center">Sin transacciones.</div>`; return; }
            const allTransactions = [...daySales.map(s => ({ ...s, isGasto: false })), ...dayGastosArr.map(g => ({ ...g, isGasto: true, type: 'GASTO' }))].sort((a, b) => b.date - a.date); 
            allTransactions.forEach(t => {
                let icon, color, titulo, subtitulo, montoHtml, methodHtml;
                if (t.isGasto) { icon = 'trending-down'; color = 'text-red-400'; titulo = 'Gasto'; subtitulo = t.desc; montoHtml = `<p class="font-bold text-red-400 text-xs md:text-sm">- S/ ${t.monto.toFixed(2)}</p>`; methodHtml = `<p class="text-[9px] md:text-[10px] text-slate-500 uppercase">${t.method || 'efectivo'}</p>`; } 
                else if (t.type === 'AGENTE') { icon = 'landmark'; color = 'text-bcp'; titulo = `Agente ${t.banco}`; subtitulo = `${t.tipoOperacion}`; montoHtml = `<p class="font-bold text-emerald-400 text-xs md:text-sm">+ S/ ${(t.profit || 0).toFixed(2)}</p>`; methodHtml = `<p class="text-[9px] md:text-[10px] text-slate-500 uppercase">${t.method || 'efectivo'}</p>`; } 
                else { 
                    icon = t.type === 'SOAT' ? 'shield-check' : 'shopping-cart'; color = t.type === 'SOAT' ? 'text-indigo-400' : 'text-emerald-400'; titulo = `Venta ${t.type}`; subtitulo = t.type === 'SOAT' ? `${t.placa}` : `${t.items ? t.items.length : 0} item(s)`; 
                    let saleProfit = t.profit !== undefined ? t.profit : t.total; 
                    montoHtml = `<p class="font-bold text-emerald-400 text-xs md:text-sm">+ S/ ${saleProfit.toFixed(2)}</p>`; methodHtml = `<p class="text-[9px] md:text-[10px] text-slate-500 uppercase">${t.method || 'efectivo'}</p>`; 
                }
                list.insertAdjacentHTML('beforeend', `<div onclick="showTransactionDetails(${t.id}, '${t.type}')" class="bg-slate-900 p-2.5 md:p-3 rounded-lg border border-slate-700 flex justify-between items-center cursor-pointer hover:border-indigo-500 transition-colors"><div class="flex items-center gap-2 md:gap-3"><i data-lucide="${icon}" class="w-4 h-4 md:w-5 md:h-5 ${color}"></i><div><p class="text-xs md:text-sm font-bold text-white">${titulo}</p><p class="text-[10px] md:text-xs text-slate-400 truncate max-w-[100px] md:max-w-[160px]">${subtitulo}</p></div></div><div class="text-right flex flex-col items-end">${montoHtml}${methodHtml}</div></div>`);
            }); updateIcons();
        }

        // --- MODAL DETALLES/EDICIÓN ---
        function showTransactionDetails(id, type) {
            const modal = document.getElementById('txDetailsModal'); const body = document.getElementById('txModalBody'); const title = document.getElementById('txModalTitle'); const footer = document.getElementById('txModalFooter'); body.innerHTML = '';
            footer.innerHTML = `<button onclick="deleteTransaction(${id}, '${type}')" class="px-3 md:px-4 py-2 md:py-2.5 rounded-lg font-medium text-white bg-red-600 hover:bg-red-500 transition-colors flex items-center justify-center"><i data-lucide="trash-2" class="w-4 h-4 md:w-5 md:h-5"></i></button><button onclick="editTransaction(${id}, '${type}')" class="flex-1 py-2 md:py-2.5 rounded-lg font-medium text-white bg-indigo-600 hover:bg-indigo-500 transition-colors flex justify-center items-center gap-2 text-sm md:text-base"><i data-lucide="edit" class="w-4 h-4 md:w-5 md:h-5"></i> Editar</button><button onclick="closeTxModal()" class="px-3 md:px-4 py-2 md:py-2.5 rounded-lg text-sm md:text-base font-medium text-slate-300 bg-slate-700 hover:bg-slate-600 hover:text-white transition-colors">Cerrar</button>`;
            
            if (type === 'POS') {
                const sale = window.salesHistory.find(s => s.id == id); if(!sale) return; title.innerHTML = `<i data-lucide="receipt" class="w-5 h-5 text-emerald-400"></i> Venta POS`;
                let itemsHtml = sale.items ? sale.items.map(item => {
                    let desc = item.product?.size || '-';
                    let name = item.product?.name || 'Desconocido';
                    
                    if (item.type === 'package') {
                        desc += ` (Paquete x${item.product.unitsPerGroup})`;
                    } else if (item.type === 'promo') {
                        const promo = item.product.promos?.find(pr => pr.id === item.promoId);
                        if (promo) {
                            name = `⭐ ${promo.name} (${name})`;
                            const extraNames = promo.items?.map(pi => {
                                const invItem = window.inventory.find(x => x.id == pi.id);
                                return invItem ? `${pi.qty}x ${invItem.name}` : '';
                            }).filter(Boolean).join(' + ');
                            if (extraNames) desc += ` + ${extraNames}`;
                        }
                    }

                    return `<div class="flex justify-between items-center text-xs md:text-sm mb-2 border-b border-slate-700/50 pb-2 last:border-0 last:mb-0 last:pb-0"><div><p class="text-white">${name}</p><p class="text-[10px] md:text-xs text-slate-400">${item.qty} unid(s) • ${desc}</p></div><p class="font-bold text-emerald-400">S/ ${calculateItemTotal(item).toFixed(2)}</p></div>`;
                }).join('') : '';

                body.innerHTML = `<div class="mb-4"><p class="text-[10px] md:text-xs text-slate-400 mb-1">Fecha y Hora</p><p class="text-xs md:text-sm text-white">${new Date(sale.date).toLocaleString('es-PE')}</p></div><div class="bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700 mb-4"><p class="text-[10px] md:text-xs font-bold text-slate-500 uppercase mb-2 md:mb-3 tracking-wider">Productos</p>${itemsHtml}</div><div class="flex justify-between items-center bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700"><div><p class="text-[10px] md:text-xs text-slate-400">Total Ingresado</p><p class="text-[9px] md:text-[10px] text-slate-500 uppercase">Vía ${sale.method || 'Efectivo'}</p></div><p class="text-lg md:text-xl font-bold text-white">S/ ${sale.total.toFixed(2)}</p></div>`;
            } else if (type === 'SOAT') {
                const sale = window.salesHistory.find(s => s.id == id); if(!sale) return; title.innerHTML = `<i data-lucide="shield-check" class="w-5 h-5 text-indigo-400"></i> Detalle SOAT`;
                body.innerHTML = `<div class="mb-4"><p class="text-[10px] md:text-xs text-slate-400 mb-1">Fecha y Hora</p><p class="text-xs md:text-sm text-white">${new Date(sale.date).toLocaleString('es-PE')}</p></div><div class="bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700 space-y-2 md:space-y-3 mb-4"><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">Placa:</span><span class="text-white font-bold text-xs md:text-sm">${sale.placa}</span></div><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">Vehículo:</span><span class="text-white text-xs md:text-sm">${sale.tipoVehiculo}</span></div><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">DNI/RUC:</span><span class="text-white text-xs md:text-sm">${sale.dni}</span></div><div><span class="block text-slate-400 text-xs md:text-sm mb-1">Anotación:</span><span class="block text-white text-xs md:text-sm bg-slate-800 p-2 rounded">${sale.soatDesc || 'Sin anotación.'}</span></div></div><div class="flex justify-between items-center bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700"><div><p class="text-[10px] md:text-xs text-slate-400">Cobrado al Cliente</p><p class="text-[9px] md:text-[10px] text-slate-500 uppercase">Vía ${sale.method || 'Efectivo'}</p></div><div class="text-right border-l border-slate-700 pl-3 md:pl-4"><p class="text-[10px] md:text-xs text-slate-400">Ganancia Neta</p><p class="text-base md:text-xl font-bold text-emerald-400">S/ ${(sale.profit || sale.total).toFixed(2)}</p></div></div>`;
            } else if (type === 'AGENTE') {
                const sale = window.salesHistory.find(s => s.id == id); if(!sale) return; title.innerHTML = `<i data-lucide="landmark" class="w-5 h-5 text-bcp"></i> Agente BCP`;
                body.innerHTML = `<div class="mb-4"><p class="text-[10px] md:text-xs text-slate-400 mb-1">Fecha y Hora</p><p class="text-xs md:text-sm text-white">${new Date(sale.date).toLocaleString('es-PE')}</p></div><div class="bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700 space-y-2 md:space-y-3 mb-4"><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">Entidad:</span><span class="text-white font-bold text-xs md:text-sm">${sale.banco}</span></div><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">Operación:</span><span class="text-white text-xs md:text-sm">${sale.tipoOperacion}</span></div><div class="flex justify-between border-b border-slate-800 pb-2"><span class="text-slate-400 text-xs md:text-sm">Documento / Cuenta:</span><span class="text-white text-xs md:text-sm">${sale.doc}</span></div></div><div class="flex justify-between items-center bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700"><div><p class="text-[10px] md:text-xs text-slate-400">Monto Operación</p><p class="text-[9px] md:text-[10px] text-slate-500 uppercase">Vía ${sale.method || 'Efectivo'}</p></div><div class="text-right border-l border-slate-700 pl-3 md:pl-4"><p class="text-[10px] md:text-xs text-slate-400">Ganancia Neta</p><p class="text-base md:text-xl font-bold text-emerald-400">S/ ${(sale.profit || 0).toFixed(2)}</p></div></div>`;
            } else if (type === 'GASTO') {
                const gasto = window.gastosHistory.find(g => g.id == id); if(!gasto) return; title.innerHTML = `<i data-lucide="trending-down" class="w-5 h-5 text-red-400"></i> Detalle Gasto`;
                body.innerHTML = `<div class="mb-4"><p class="text-[10px] md:text-xs text-slate-400 mb-1">Fecha y Hora</p><p class="text-xs md:text-sm text-white">${new Date(gasto.date).toLocaleString('es-PE')}</p></div><div class="bg-slate-900 rounded-lg p-3 md:p-4 border border-slate-700 mb-4"><p class="text-[10px] md:text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Concepto</p><p class="text-white text-sm md:text-base">${gasto.desc}</p></div><div class="flex justify-between items-center bg-red-900/20 rounded-lg p-3 md:p-4 border border-red-500/20"><div><p class="text-[10px] md:text-xs text-red-400 font-bold">Monto Retirado</p><p class="text-[9px] md:text-[10px] text-red-300/70 uppercase">Vía ${gasto.method || 'Efectivo'}</p></div><p class="text-lg md:text-xl font-bold text-red-400">S/ ${gasto.monto.toFixed(2)}</p></div>`;
            }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); modal.children[0].classList.add('scale-100'); }, 10); updateIcons();
        }

        function closeTxModal() { const modal = document.getElementById('txDetailsModal'); modal.classList.add('opacity-0'); modal.children[0].classList.remove('scale-100'); modal.children[0].classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }

        function deleteTransaction(id, type) {
            if (type === 'GASTO') { window.gastosHistory = window.gastosHistory.filter(g => g.id != id); } 
            else { 
                const sale = window.salesHistory.find(s => s.id == id); 
                if (sale && type === 'POS') { 
                    (sale.items || []).forEach(item => { 
                        const inv = window.inventory.find(p => p.id == item.product?.id); 
                        if (inv) {
                            if (item.type === 'package') inv.stock += (item.qty * inv.unitsPerGroup);
                            else inv.stock += item.qty;
                        }
                        if (item.type === 'promo') {
                            const promo = item.product.promos?.find(pr => pr.id === item.promoId);
                            if (promo && promo.items) {
                                promo.items.forEach(pi => {
                                    const lInv = window.inventory.find(x => x.id == pi.id);
                                    if(lInv) lInv.stock += (item.qty * pi.qty);
                                });
                            }
                        }
                    }); 
                } 
                window.salesHistory = window.salesHistory.filter(s => s.id != id); 
            }
            saveData(); closeTxModal(); renderActiveViewOnly(); 
        }

        function editTransaction(id, type) {
            closeTxModal();
            if (type === 'GASTO') {
                const g = window.gastosHistory.find(x => x.id == id); if(g) { window.editingGasto = { id: g.id, date: new Date(g.date), originalData: {...g} }; window.gastosHistory = window.gastosHistory.filter(x => x.id != id); saveData(); document.getElementById('gastoDesc').value = g.desc; document.getElementById('gastoMonto').value = g.monto; document.querySelector(`input[name="gastoPayment"][value="${g.method || 'efectivo'}"]`).checked = true; document.getElementById('gastoHeaderTitle').innerHTML = '<i data-lucide="edit" class="w-5 h-5 text-indigo-400 inline"></i> Editando Gasto'; document.getElementById('btnGasto').textContent = 'Guardar'; document.getElementById('btnGasto').classList.replace('bg-slate-700', 'bg-indigo-600'); document.getElementById('cancelGastoEditBtn').classList.remove('hidden'); switchView('caja'); }
            } else {
                const sale = window.salesHistory.find(s => s.id == id); if (!sale) return;
                if (type === 'POS') {
                    window.editingPos = { id: sale.id, date: new Date(sale.date), originalData: {...sale} }; 
                    (sale.items || []).forEach(item => { 
                        const inv = window.inventory.find(p => p.id == item.product?.id); 
                        if (inv) {
                            if (item.type === 'package') inv.stock += (item.qty * inv.unitsPerGroup);
                            else inv.stock += item.qty;
                        }
                        if (item.type === 'promo') {
                            const promo = item.product.promos?.find(pr => pr.id === item.promoId);
                            if (promo && promo.items) {
                                promo.items.forEach(pi => {
                                    const lInv = window.inventory.find(x => x.id == pi.id);
                                    if(lInv) lInv.stock += (item.qty * pi.qty);
                                });
                            }
                        }
                    }); 
                    window.cart = [...sale.items]; document.querySelector(`input[name="payment"][value="${sale.method || 'efectivo'}"]`).checked = true; window.salesHistory = window.salesHistory.filter(s => s.id != id); saveData(); document.getElementById('ventasHeaderTitle').innerHTML = '<i data-lucide="edit" class="w-5 h-5 md:w-6 h-6 text-indigo-400 inline"></i> Editando Venta POS'; document.getElementById('cancelEditBtn').classList.remove('hidden'); switchView('ventas'); updateCartUI(); 
                } else if (type === 'SOAT') {
                    window.editingSoat = { id: sale.id, date: new Date(sale.date), originalData: {...sale} }; document.getElementById('soat_placa').value = sale.placa; document.getElementById('soat_tipo').value = sale.tipoVehiculo; document.getElementById('soat_dni').value = sale.dni; document.getElementById('soat_desc').value = sale.soatDesc || ''; document.getElementById('soat_precio').value = sale.total; document.querySelector(`input[name="soatPayment"][value="${sale.method || 'efectivo'}"]`).checked = true; window.salesHistory = window.salesHistory.filter(s => s.id != id); saveData(); document.getElementById('soatHeaderTitle').innerHTML = '<i data-lucide="edit" class="w-4 h-4 md:w-5 md:h-5 text-indigo-400 inline"></i> Editando SOAT'; document.getElementById('soatBtnText').textContent = 'Guardar Cambios'; document.getElementById('cancelSoatEditBtn').classList.remove('hidden'); switchView('soat');
                } else if (type === 'AGENTE') {
                    window.editingAgente = { id: sale.id, date: new Date(sale.date), originalData: {...sale} }; document.getElementById('agente_banco').value = sale.banco; document.getElementById('agente_tipo').value = sale.tipoOperacion; document.getElementById('agente_doc').value = sale.doc; document.getElementById('agente_monto').value = sale.total; document.querySelector(`input[name="agentePayment"][value="${sale.method || 'efectivo'}"]`).checked = true; window.salesHistory = window.salesHistory.filter(s => s.id != id); saveData(); document.getElementById('agenteHeaderTitle').innerHTML = '<i data-lucide="edit" class="w-4 h-4 md:w-5 md:h-5 text-bcp inline"></i> Editando Operación'; document.getElementById('agenteBtnText').textContent = 'Guardar Cambios'; document.getElementById('cancelAgenteEditBtn').classList.remove('hidden'); switchView('agente');
                }
            }
        }

        // --- LÓGICA DE RESPALDO Y RESTAURACIÓN ---
        function exportBackup() {
            const expInv = document.getElementById('chkExpInv').checked;
            const expHist = document.getElementById('chkExpHist').checked;
            const expConf = document.getElementById('chkExpConf').checked;

            if (!expInv && !expHist && !expConf) {
                showModal("Atención", "Debes seleccionar al menos una opción para exportar.");
                return;
            }

            let backupData = {};
            if (expInv) {
                backupData.inventory = window.inventory;
                backupData.currentIdCounter = window.currentIdCounter;
            }
            if (expHist) {
                backupData.salesHistory = window.salesHistory.map(s => ({...s, date: safeISOString(s.date)}));
                backupData.gastosHistory = window.gastosHistory.map(g => ({...g, date: safeISOString(g.date)}));
            }
            if (expConf) {
                backupData.appConfig = window.appConfig;
            }

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            
            a.href = url;
            a.download = `CajaPOS_Respaldo_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('importFileInput').click();
        }

        function handleImportBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let restoredThings = [];

                    if (data.inventory !== undefined) {
                        window.inventory = data.inventory;
                        window.currentIdCounter = data.currentIdCounter || window.currentIdCounter;
                        restoredThings.push("Inventario");
                    }
                    if (data.salesHistory !== undefined) {
                        window.salesHistory = data.salesHistory.map(s => ({...s, date: safeDateParse(s.date)}));
                        window.gastosHistory = (data.gastosHistory || []).map(g => ({...g, date: safeDateParse(g.date)}));
                        restoredThings.push("Historial");
                    }
                    if (data.appConfig !== undefined) {
                        window.appConfig = data.appConfig;
                        restoredThings.push("Configuraciones");
                    }

                    if (restoredThings.length > 0) {
                        saveData();
                        updateCategoryFilters();
                        updateCartUI();
                        renderActiveViewOnly();
                        showModal("Respaldo Restaurado", `Se ha recuperado con éxito: <br><strong class="text-white">${restoredThings.join(', ')}</strong>.`);
                    } else {
                        showModal("Error", "El archivo no contiene información válida para la aplicación.");
                    }
                } catch(err) {
                    showModal("Error", "El archivo está dañado o no tiene formato JSON válido.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Resetea el input por si quieres subir el mismo archivo después
        }

        // --- EXPOSICIÓN GLOBAL PARA HTML ---
        window.switchView = switchView; window.openAddProductModal = openAddProductModal; window.closeAddProductModal = closeAddProductModal; window.saveProduct = saveProduct; window.filterLowStock = filterLowStock; window.deleteProduct = deleteProduct; window.addToCart = addToCart; window.changeCartItemQty = changeCartItemQty; window.changeCartItemMode = changeCartItemMode; window.closeSuccessModal = closeSuccessModal; window.openConfigModal = openConfigModal; window.closeConfigModal = closeConfigModal; window.saveConfig = saveConfig; window.registerSoat = registerSoat; window.cancelEditSoat = cancelEditSoat; window.registerAgente = registerAgente; window.cancelEditAgente = cancelEditAgente; window.cerrarCaja = cerrarCaja; window.registrarGasto = registrarGasto; window.cancelEditGasto = cancelEditGasto; window.cancelEditPos = cancelEditPos; window.changeMonth = changeMonth; window.showDayDetails = showDayDetails; window.showTransactionDetails = showTransactionDetails; window.closeTxModal = closeTxModal; window.deleteTransaction = deleteTransaction; window.editTransaction = editTransaction; window.showBreakdown = showBreakdown; window.closeBreakdownModal = closeBreakdownModal;
        window.toggleAdvancedSales = toggleAdvancedSales; window.toggleGroupInputs = toggleGroupInputs; window.addQtyDiscount = addQtyDiscount; window.updateMDiscount = updateMDiscount; window.removeQtyDiscount = removeQtyDiscount; window.addPromoRow = addPromoRow; window.updateMPromo = updateMPromo; window.removePromoRow = removePromoRow; window.addPromoItem = addPromoItem; window.updateMPromoItem = updateMPromoItem; window.removePromoItem = removePromoItem;
        
        window.exportBackup = exportBackup; window.triggerImport = triggerImport; window.handleImportBackup = handleImportBackup;

        // Renderizado inicial sin bloqueos
        document.addEventListener("DOMContentLoaded", () => {
            loadDataLocally();
            switchView('ventas'); 
            updateCartUI();       
            initFirebase();       

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(()=>{}).catch(()=>{});
            }
        });

    </script>
</body>
</html>
